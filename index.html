<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#ffffff">
  
  <link rel="manifest" id="my-manifest">

  <title>PingMe Premium</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* --- MODERN CSS VARIABLES & RESET --- */
    :root {
      /* Palette */
      --primary: #FF2D55; 
      --primary-grad: linear-gradient(135deg, #FF2D55 0%, #FF5C8A 100%);
      --bg-body: #F2F2F7;
      --bg-card: #FFFFFF;
      --bg-input: #E9E9EB;
      --text-main: #000000;
      --text-muted: #8E8E93;
      --border: rgba(0,0,0,0.08);
      --glass: rgba(255, 255, 255, 0.95);
      
      /* Messages */
      --msg-me-bg: var(--primary-grad);
      --msg-me-text: #FFFFFF;
      --msg-you-bg: #E5E5EA;
      --msg-you-text: #000000;
      
      /* Utilities */
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
      --radius-md: 20px;
      --safe-area-bottom: env(safe-area-inset-bottom, 20px);
      
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    [data-theme="dark"] {
      --bg-body: #000000;
      --bg-card: #1C1C1E;
      --bg-input: #2C2C2E;
      --text-main: #FFFFFF;
      --text-muted: #98989D;
      --border: rgba(255,255,255,0.1);
      --glass: rgba(28, 28, 30, 0.95);
      --msg-you-bg: #2C2C2E;
      --msg-you-text: #FFFFFF;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    
    html, body {
      height: 100%; height: 100dvh;
      margin: 0; padding: 0;
      background: var(--bg-body); color: var(--text-main);
      overflow: hidden;
      position: fixed; width: 100%; font-size: 15px; line-height: 1.4;
    }

    /* --- LOADING SPINNER (Double Ring) --- */
    .lds-dual-ring {
      display: inline-block;
      width: 60px;
      height: 60px;
    }
    .lds-dual-ring:after {
      content: " ";
      display: block;
      width: 48px;
      height: 48px;
      margin: 6px;
      border-radius: 50%;
      border: 5px solid var(--primary);
      border-color: var(--primary) transparent var(--primary) transparent;
      animation: lds-dual-ring 1.2s linear infinite;
    }
    @keyframes lds-dual-ring {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* --- UTILITIES --- */
    .glass-panel {
      background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
    }
    .hidden { display: none !important; }
    
    /* --- VIEW MANAGEMENT --- */
    .view-section { 
      display: none; flex-direction: column; 
      height: 100%; height: 100dvh; 
      width: 100%; 
      position: absolute; top:0; left:0; background: var(--bg-body);
      overflow: hidden;
    }
    .view-section.active { display: flex; animation: fadeIn 0.3s ease-out; z-index: 10; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.99); } to { opacity: 1; transform: scale(1); } }

    /* --- HEADER --- */
    header.app {
      display: flex; align-items: center; justify-content: space-between; 
      padding: 12px 16px; height: 60px; z-index: 50; flex-shrink: 0;
      padding-top: max(12px, env(safe-area-inset-top));
    }
    .header-title { 
      font-weight: 700; font-size: 17px; 
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
    }
    .icon-btn {
      background: transparent; border: none; color: var(--primary); 
      width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      transition: background 0.2s; cursor: pointer; padding: 0;
    }
    .icon-btn:active { background: rgba(0,0,0,0.05); }

    /* --- LISTS --- */
    .list-container {
      flex: 1; overflow-y: auto; padding: 10px 16px 100px;
      -webkit-overflow-scrolling: touch;
    }
    .user-card {
      display: flex; align-items: center; gap: 14px; padding: 12px;
      background: var(--bg-card); border-radius: var(--radius-md); margin-bottom: 10px;
      box-shadow: var(--shadow-sm); transition: transform 0.1s, box-shadow 0.2s;
      cursor: pointer; border: 1px solid transparent; user-select: none;
    }
    .user-card:active, .user-card.long-press-active { transform: scale(0.96); background: var(--bg-input); }
    
    .avatar-wrapper { position: relative; width: 48px; height: 48px; flex-shrink: 0; }
    .avatar { 
      width: 100%; height: 100%; border-radius: 50%; background: var(--bg-input); 
      object-fit: cover; display: flex; align-items: center; justify-content: center;
      font-weight: 700; color: var(--text-muted); font-size: 18px; overflow: hidden;
      border: 1px solid var(--border);
    }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .status-dot { 
      width: 12px; height: 12px; border-radius: 50%; background: #4CD964; 
      position: absolute; bottom: 0; right: 0; border: 2px solid var(--bg-card);
      display: none; box-shadow: 0 0 0 2px var(--bg-card);
    }
    .status-dot.online { display: block; animation: pulse 2s infinite; }
    
    .card-info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
    .card-top { display: flex; justify-content: space-between; align-items: center; }
    .card-name { font-weight: 600; font-size: 16px; color: var(--text-main); }
    .card-time { font-size: 12px; color: var(--text-muted); }
    .card-msg { font-size: 13px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Search Result Specific */
    .search-result-card {
        justify-content: space-between;
    }
    .btn-msg-action {
        background: var(--primary); color: white; border: none; padding: 6px 14px;
        border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer;
    }

    /* --- CHAT AREA FIXED --- */
    main.chat-view {
        flex: 1; display: flex; flex-direction: column; background: var(--bg-body); 
        position: relative; overflow: hidden; width: 100%;
    }
    .messages-area {
        flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; 
        gap: 2px; padding-bottom: 20px; -webkit-overflow-scrolling: touch;
    }
    .date-separator {
        align-self: center; background: rgba(128,128,128,0.15); padding: 4px 12px;
        border-radius: 12px; font-size: 11px; font-weight: 600; color: var(--text-muted);
        margin: 16px 0 8px;
    }

    .msg-row { display: flex; width: 100%; margin-bottom: 2px; position: relative; align-items: flex-end;}
    .msg-row.me { justify-content: flex-end; }
    .msg-row.you { justify-content: flex-start; }
    
    .msg-bubble {
      max-width: 75%; padding: 10px 14px; font-size: 15px; position: relative; word-wrap: break-word;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.1s; user-select: none;
    }
    .msg-bubble:active { transform: scale(0.98); }
    
    .msg-row.me .msg-bubble { 
      background: var(--msg-me-bg); color: var(--msg-me-text); border-radius: 18px 4px 18px 18px; 
    }
    .msg-row.you .msg-bubble { 
      background: var(--msg-you-bg); color: var(--msg-you-text); border-radius: 4px 18px 18px 18px; 
    }
    .msg-bubble img.chat-img { border-radius: 12px; max-width: 100%; display: block; margin-top: 4px; }
    .msg-meta { font-size: 9px; margin-top: 4px; opacity: 0.7; text-align: right; display: flex; justify-content: flex-end; gap:3px; }
    
    /* Footer & Input FIXED */
    .chat-input-area {
      flex-shrink: 0; background: var(--glass); backdrop-filter: blur(20px); border-top: 1px solid var(--border);
      padding: 10px 16px; padding-bottom: max(10px, env(safe-area-inset-bottom));
      display: flex; flex-direction: column; gap: 8px; z-index: 60; width: 100%;
    }
    .input-wrapper {
      display: flex; align-items: flex-end; gap: 8px; background: var(--bg-input);
      border-radius: 24px; padding: 6px 6px 6px 12px; border: 1px solid transparent; transition: border 0.2s;
    }
    .input-wrapper:focus-within { border-color: var(--primary); background: var(--bg-card); }
    textarea.chat-box {
      flex: 1; background: transparent; border: none; font-size: 15px; color: var(--text-main);
      resize: none; max-height: 120px; padding: 10px 0; line-height: 20px;
    }
    .btn-send {
      width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: white;
      border: none; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(255, 45, 85, 0.4); transition: transform 0.1s; margin-bottom: 2px;
    }
    .btn-send:active { transform: scale(0.9); }
    
    .reply-preview {
      display: none; align-items: center; justify-content: space-between;
      padding: 8px 12px; background: var(--bg-input); border-radius: 12px; font-size: 12px;
      border-left: 3px solid var(--primary); margin-bottom: 4px;
    }
    .reply-preview.active { display: flex; }

    /* --- BOTTOM NAV --- */
    .bottom-nav {
      position: absolute; bottom: 0; width: 100%; height: calc(60px + env(safe-area-inset-bottom));
      background: var(--glass); backdrop-filter: blur(20px); border-top: 1px solid var(--border);
      display: flex; justify-content: space-around; padding-bottom: env(safe-area-inset-bottom); z-index: 100;
    }
    .nav-item {
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: var(--text-muted); gap: 4px; cursor: pointer; transition: color 0.2s;
    }
    .nav-item.active { color: var(--primary); }
    .nav-item svg { width: 24px; height: 24px; }
    .nav-label { font-size: 10px; font-weight: 500; }

    /* --- PROFILE & SETTINGS --- */
    .profile-container { padding: 20px; padding-bottom: 100px; overflow-y: auto; height: 100%; }
    .large-avatar-box {
      width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 16px;
      position: relative; box-shadow: var(--shadow-lg); background: var(--bg-card);
    }
    .large-avatar-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
    .cam-badge {
      position: absolute; bottom: 0; right: 0; background: var(--primary); color: white;
      width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      border: 3px solid var(--bg-body); cursor: pointer;
    }
    .settings-group {
      background: var(--bg-card); border-radius: 16px; padding: 0 16px; margin-bottom: 20px; box-shadow: var(--shadow-sm);
    }
    .settings-item {
      padding: 16px 0; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border);
    }
    .settings-item:last-child { border-bottom: none; }
    .settings-label { font-size: 15px; font-weight: 500; }
    .settings-input { border: none; background: transparent; text-align: right; font-size: 15px; color: var(--text-muted); width: 60%; }

    /* Switch */
    .switch { position: relative; width: 50px; height: 30px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; inset: 0; background: #E9E9EB; border-radius: 30px; transition: .4s; cursor: pointer; }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background: white; border-radius: 50%; transition: .4s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    input:checked + .slider { background: var(--primary); }
    input:checked + .slider:before { transform: translateX(20px); }

    /* --- AUTH --- */
    .auth-wrap {
      padding: 40px 30px; display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100%; text-align: center; overflow-y: auto;
    }
    .auth-card { width: 100%; max-width: 400px; }
    .input-field {
      width: 100%; padding: 16px; margin: 8px 0; border-radius: 16px; border: 1px solid var(--border);
      background: var(--bg-input); color: var(--text-main); font-size: 16px; transition: border 0.2s;
    }
    .input-field:focus { border-color: var(--primary); background: var(--bg-card); }
    .btn-primary {
      width: 100%; padding: 16px; margin-top: 16px; border-radius: 16px; border: none;
      background: var(--primary-grad); color: white; font-size: 16px; font-weight: 600;
      box-shadow: 0 8px 20px rgba(255, 45, 85, 0.25); cursor: pointer; transition: transform 0.1s;
    }
    .btn-primary:active { transform: scale(0.98); }

    /* --- ACTION SHEET (Context Menu) --- */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
      z-index: 2000; opacity: 0; visibility: hidden; transition: 0.3s;
      display: flex; align-items: flex-end; justify-content: center;
    }
    .overlay.active { opacity: 1; visibility: visible; }
    .action-sheet {
      width: 100%; max-width: 500px; background: var(--bg-card);
      border-radius: 24px 24px 0 0; padding: 24px; transform: translateY(100%); 
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      box-shadow: var(--shadow-lg); display: flex; flex-direction: column; gap: 8px;
    }
    .overlay.active .action-sheet { transform: translateY(0); }
    .sheet-header { text-align: center; margin-bottom: 10px; color: var(--text-muted); font-size: 13px; font-weight: 600; }
    .sheet-btn {
      width: 100%; padding: 16px; border-radius: 16px; border: none; background: var(--bg-input);
      color: var(--text-main); font-size: 16px; font-weight: 600; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .sheet-btn.danger { background: rgba(255, 59, 48, 0.1); color: #FF3B30; }
    .sheet-btn:active { transform: scale(0.98); }

    /* --- TOAST --- */
    .toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
      background: var(--glass); backdrop-filter: blur(20px); padding: 12px 24px;
      border-radius: 30px; box-shadow: var(--shadow-lg); border: 1px solid var(--border);
      font-weight: 600; color: var(--text-main); z-index: 3000; transition: 0.4s;
      display: flex; align-items: center; gap: 8px;
    }
    .toast.active { transform: translateX(-50%) translateY(0); }

    /* --- LIGHTBOX --- */
    #lightbox { 
      position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; 
      display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; 
    }
    #lightbox.active { opacity: 1; pointer-events: auto; }
    #lightbox img { max-width: 100%; max-height: 100%; transition: transform 0.2s; }
  </style>

  <script>
    const manifestData = {
        "name": "PingMe Premium",
        "short_name": "PingMe",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#ffffff",
        "theme_color": "#FF2D55",
        "icons": [{"src": "https://i.postimg.cc/RZ5FH16z/Gemini-Generated-Image-rgsqsqrgsqsqrgsq-removebg-preview.png","sizes": "192x192","type": "image/png"}]
    };
    const blobManifest = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
    document.getElementById('my-manifest').setAttribute('href', URL.createObjectURL(blobManifest));

    if ('serviceWorker' in navigator) {
         navigator.serviceWorker.register('sw.js').catch(() => {
             // Fallback dummy
         });
    }
  </script>
</head>
<body>

  <!-- TOAST -->
  <div id="toastMsg" class="toast">
    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>
    <span id="toastText">Success</span>
  </div>

  <!-- SPLASH SCREEN -->
  <div id="splash-screen" style="position:fixed;inset:0;background:var(--bg-body);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 0.5s;">
    <div style="font-size:50px;font-weight:900;background:var(--primary-grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">PingMe</div>
    <div style="margin-top:20px;">
        <div class="lds-dual-ring"></div>
    </div>
  </div>

  <!-- LIGHTBOX -->
  <div id="lightbox">
      <button id="lightbox-close" style="position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.2);color:white;border:none;border-radius:50%;width:40px;height:40px;font-size:24px;cursor:pointer;">&times;</button>
      <img id="lightbox-img" src="">
  </div>

  <!-- ACTION SHEET (CONTEXT MENU) -->
  <div id="actionSheetOverlay" class="overlay">
    <div class="action-sheet" id="actionSheetContent">
       <!-- Dynamic Buttons -->
    </div>
  </div>

  <div class="wrap" style="height:100%;">
      
      <!-- AUTH VIEW -->
      <div id="view-auth" class="view-section active">
          <div class="auth-wrap">
              <div class="auth-card">
                  <img src="https://i.postimg.cc/RZ5FH16z/Gemini-Generated-Image-rgsqsqrgsqsqrgsq-removebg-preview.png" width="80" style="margin-bottom:20px; border-radius:16px; box-shadow: 0 10px 20px rgba(255,45,85,0.2);">
                  <div style="font-size:48px; font-weight:900; margin-bottom:8px; color:var(--primary);">PingMe</div>
                  <p style="color:var(--text-muted); margin-bottom:30px;">Sign in to continue</p>

                  <div id="signup-fields" class="hidden">
                      <input id="auth-name" class="input-field" placeholder="Full Name" />
                  </div>
                  <input id="auth-email" class="input-field" placeholder="Email Address" type="email" />
                  <input id="auth-pass" class="input-field" placeholder="Password (6+ chars)" type="password" />
                  
                  <div id="auth-error" style="color:#FF3B30; font-size:13px; margin:10px 0; display:none;">Error</div>

                  <button id="auth-btn" class="btn-primary">Sign In</button>
                  <div id="forgot-pass-btn" style="margin-top:15px; color:var(--primary); font-weight:600; font-size:13px; cursor:pointer;">Forgot Password?</div>
                  <div id="auth-toggle" style="margin-top:20px; color:var(--text-muted); font-size:14px; cursor:pointer;">Don't have an account? <span style="color:var(--text-main); font-weight:600;">Sign Up</span></div>
              </div>
          </div>
      </div>

      <!-- HOME VIEW (Chat List) -->
      <div id="view-home" class="view-section">
          <header class="app glass-panel">
             <div class="header-title" style="font-size:22px; font-weight:800;">Chats</div>
             <button class="icon-btn" id="profile-header-btn">
                <div class="avatar" style="width:34px; height:34px;">
                    <img id="header-avatar-img" src="" style="display:none;">
                    <span id="header-avatar-text">U</span>
                </div>
             </button>
          </header>
          
          <div class="list-container" id="chat-list-container">
              <div style="text-align:center; padding:50px; color:var(--text-muted);">
                  <div class="lds-dual-ring" style="transform:scale(0.5);"></div>
                  <div>Loading Chats...</div>
              </div>
          </div>

          <nav class="bottom-nav">
              <div class="nav-item active" id="nav-chats">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                  <span class="nav-label">Chats</span>
              </div>
              <div class="nav-item" id="nav-find">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                  <span class="nav-label">Search</span>
              </div>
              <div class="nav-item" id="nav-profile">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                  <span class="nav-label">Profile</span>
              </div>
          </nav>
      </div>

      <!-- FIND FRIENDS VIEW -->
      <div id="view-find" class="view-section" style="z-index: 20;">
          <header class="app glass-panel">
              <button class="icon-btn" id="back-from-find">
                  <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
              </button>
              <div class="header-title">Find Friends</div>
          </header>
          <div class="profile-container">
             <div class="input-wrapper" style="margin-bottom:20px; background:var(--bg-card); padding:8px 16px;">
                 <input id="search-ping-id" class="chat-box" placeholder="Enter Ping ID (e.g. pm_AbCd12)" style="height:auto;">
                 <button id="search-btn" class="icon-btn" style="background:var(--primary); color:white; width:32px; height:32px;">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                 </button>
             </div>
             
             <div id="search-history-section">
                <h4 style="margin:0 0 10px; font-size:13px; color:var(--text-muted); display:flex; justify-content:space-between;">
                    RECENT SEARCHES
                    <span id="clear-history-btn" style="color:#FF3B30; cursor:pointer;">Clear</span>
                </h4>
                <div id="history-list" style="display:flex; gap:15px; overflow-x:auto; padding-bottom:10px;"></div>
             </div>
             
             <div id="search-results" style="margin-top:20px;"></div>
          </div>
      </div>

      <!-- CHAT ROOM VIEW -->
      <div id="view-chat" class="view-section" style="z-index: 30;">
          <header class="app glass-panel" style="justify-content: flex-start; gap: 10px;">
              <button class="icon-btn" id="chat-back-btn">
                  <svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
              </button>
              
              <div class="avatar" id="chat-header-avatar-container" style="width:36px; height:36px; border:1px solid var(--border);">
                   <img id="chat-header-img" src="" style="display:none;">
                   <span id="chat-header-initial">?</span>
              </div>

              <div id="chat-user-header" style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:flex-start; cursor:pointer;">
                  <div class="header-title" id="chat-header-name" style="font-size:16px;">User</div>
                  <div id="chat-header-status" style="font-size:11px; color:var(--text-muted); font-weight:500;">Offline</div>
              </div>
          </header>
          
          <main class="chat-view">
              <div class="messages-area" id="messages"></div>
              
              <div id="typing-indicator" style="padding:0 20px 10px; font-size:11px; color:var(--text-muted); display:none;">
                  <span style="font-weight:600;">Typing...</span>
              </div>
              
              <footer class="chat-input-area">
                <div id="blocked-banner" style="background:#FFE5E5; color:#FF3B30; padding:10px; text-align:center; border-radius:12px; font-size:13px; display:none; font-weight:600; margin-bottom:5px;"></div>
                
                <div id="input-area-wrapper">
                    <div class="reply-preview" id="replyPreview">
                        <div style="flex:1; overflow:hidden;">
                            <span style="color:var(--primary); font-weight:700;" id="replyToName">Name</span>
                            <div style="font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" id="replyTextPreview">Text</div>
                        </div>
                        <button id="cancelReply" style="background:none; border:none; color:var(--text-muted); font-size:20px;">&times;</button>
                    </div>

                    <div class="input-wrapper">
                        <input type="file" id="img-input" accept="image/*" hidden />
                        <button class="icon-btn" id="img-btn" style="width:32px; height:32px; color:var(--text-muted);">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        </button>
                        <textarea id="msg-input" class="chat-box" rows="1" placeholder="iMessage"></textarea>
                        <button class="btn-send" id="send-btn">
                            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M12 5l7 7-7 7" /></svg>
                        </button>
                    </div>
                </div>
              </footer>
          </main>
      </div>

      <!-- MY PROFILE VIEW -->
      <div id="view-profile" class="view-section" style="z-index: 20;">
          <header class="app glass-panel">
              <button class="icon-btn" id="back-from-profile">
                  <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
              </button>
              <div class="header-title">My Profile</div>
              <button class="icon-btn" id="logout-btn" style="color:#FF3B30;">
                  <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
              </button>
          </header>
          
          <div class="profile-container">
              <div class="large-avatar-box">
                  <img id="profile-img-preview" class="large-avatar-img" src="" onclick="if(this.src) viewImg(this.src)">
                  <div id="profile-initial-preview" style="width:100%; height:100%; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:40px; font-weight:700; color:var(--text-muted);">U</div>
                  <label for="profile-file-input" class="cam-badge">
                      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  </label>
                  <input type="file" id="profile-file-input" hidden accept="image/*">
              </div>
              
              <div style="text-align:center; margin-bottom:20px;">
                  <h2 id="current-user-display-name" style="margin:0; font-size:22px;">Loading...</h2>
                  <div id="my-ping-id" style="color:var(--text-muted); font-size:13px; margin-top:4px;">@...</div>
              </div>

              <div class="settings-group">
                  <div class="settings-item">
                      <span class="settings-label">Dark Mode</span>
                      <label class="switch">
                          <input type="checkbox" id="theme-toggle">
                          <span class="slider"></span>
                      </label>
                  </div>
              </div>

              <div class="settings-group">
                  <div class="settings-item">
                      <span class="settings-label">Display Name</span>
                      <input id="edit-name" class="settings-input" placeholder="Your Name">
                  </div>
                  <div class="settings-item">
                      <span class="settings-label">Bio</span>
                      <input id="edit-bio" class="settings-input" placeholder="Add a bio...">
                  </div>
                  <div class="settings-item">
                      <span class="settings-label">Phone</span>
                      <input id="edit-phone" class="settings-input" type="tel" placeholder="Phone Number">
                  </div>
                  <div class="settings-item">
                      <span class="settings-label">Email</span>
                      <input id="edit-email" class="settings-input" disabled style="opacity:0.6;">
                  </div>
              </div>
              
              <button id="save-profile-btn" class="btn-primary" style="margin-top:0;">Save Changes</button>
          </div>
      </div>

      <!-- FRIEND PROFILE VIEW -->
      <div id="view-friend-profile" class="view-section" style="z-index: 40;">
          <header class="app glass-panel">
              <button class="icon-btn" id="back-from-friend-profile">
                  <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
              </button>
              <div class="header-title">Friend's Profile</div>
          </header>
          
          <div class="profile-container">
              <div class="large-avatar-box" style="margin-bottom:10px;">
                  <img id="friend-img-preview" class="large-avatar-img" src="" onclick="if(this.src) viewImg(this.src)">
                  <div id="friend-initial-preview" style="width:100%; height:100%; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:40px; font-weight:700; color:var(--text-muted);">U</div>
              </div>
              
              <div style="text-align:center; margin-bottom:30px;">
                  <h2 id="friend-display-name" style="margin:0; font-size:22px;">Name</h2>
                  <div id="friend-ping-id" style="color:var(--text-muted); font-size:13px; margin-top:4px;">@...</div>
              </div>

              <div class="settings-group">
                  <div class="settings-item">
                      <span class="settings-label">Bio</span>
                      <span id="friend-bio" style="color:var(--text-muted);">...</span>
                  </div>
                  <div class="settings-item">
                      <span class="settings-label">Email</span>
                      <span id="friend-email" style="color:var(--text-muted);">...</span>
                  </div>
              </div>

              <button id="friend-block-btn" class="btn-primary" style="background:#FF3B30; margin-top:0;">Block User</button>
          </div>
      </div>

  </div> 

  <!-- JAVASCRIPT LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, sendEmailVerification, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, query, collection, where, onSnapshot, serverTimestamp, increment, orderBy, limit, addDoc, arrayUnion, arrayRemove, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAOEmgVj-OzfVaZsNOn47WTdaCrb5h8h_s",
      authDomain: "ping-me-app-475d1.firebaseapp.com",
      databaseURL: "https://ping-me-app-475d1-default-rtdb.firebaseio.com",
      projectId: "ping-me-app-475d1",
      storageBucket: "ping-me-app-475d1.firebasestorage.app",
      messagingSenderId: "41337345094",
      appId: "1:41337345094:web:0a6f31fd1dd0a1f6026647",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const USERS_PATH = `artifacts/${firebaseConfig.projectId}/public/data/users`;
    const CHATS_PATH = `artifacts/${firebaseConfig.projectId}/public/data/chat_rooms`;

    // --- STATE ---
    let currentUser = null, currentUserData = null;
    let currentChatId = null, currentPartnerId = null, currentPartnerData = null;
    let unsubscribeChats, unsubscribeMsgs, unsubscribeRoom, unsubscribePartnerStatus;
    let isLoginMode = true, isSigningUp = false;
    let replyTo = null, currentMsgId = null;
    let globalNotificationUnsubscribe = null;

    // --- HELPER: TIME AGO ---
    function formatTimeAgo(date) {
        if(!date) return '';
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + "y ago";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + "mo ago";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + "d ago";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + "h ago";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + "m ago";
        return "Active just now";
    }

    // --- UI HELPERS ---
    const get = (id) => document.getElementById(id);
    const showToast = (msg) => {
        const t = get('toastMsg'); get('toastText').textContent = msg;
        t.classList.add('active'); setTimeout(() => t.classList.remove('active'), 2500);
    };
    const showView = (id) => {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        get(id).classList.add('active');
        // Bottom Nav Highlight
        if(id === 'view-home' || id === 'view-find' || id === 'view-profile') {
           document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
           if(id === 'view-home') get('nav-chats').classList.add('active');
           if(id === 'view-find') get('nav-find').classList.add('active');
           if(id === 'view-profile') get('nav-profile').classList.add('active');
        }
    };
    window.viewImg = (src) => { get('lightbox-img').src=src; get('lightbox').classList.add('active'); };
    get('lightbox-close').onclick = () => get('lightbox').classList.remove('active');

    // --- AUTHENTICATION ---
    onAuthStateChanged(auth, async (user) => {
        const splash = get('splash-screen');
        if (user) {
            if (!user.emailVerified && !isSigningUp) {
                await signOut(auth);
                showToast("Please verify your email.");
                showView('view-auth'); splash.style.opacity = 0; setTimeout(()=>splash.classList.add('hidden'),500);
                return;
            }
            if(isSigningUp) return;
            currentUser = user;
            await loadUserProfile(user.uid);
            showView('view-home');
            loadChatList();
            updatePresence('online');
            listenGlobalMessages();
            splash.style.opacity = 0; setTimeout(()=>splash.classList.add('hidden'),500);
        } else {
            currentUser = null; currentUserData = null;
            showView('view-auth');
            splash.style.opacity = 0; setTimeout(()=>splash.classList.add('hidden'),500);
        }
    });

    get('auth-toggle').addEventListener('click', () => {
        isLoginMode = !isLoginMode;
        get('signup-fields').classList.toggle('hidden');
        get('auth-btn').textContent = isLoginMode ? 'Sign In' : 'Sign Up';
        get('auth-toggle').innerHTML = isLoginMode ? `Don't have an account? <span style="color:var(--text-main); font-weight:600;">Sign Up</span>` : `Already have an account? <span style="color:var(--text-main); font-weight:600;">Sign In</span>`;
    });

    get('auth-btn').addEventListener('click', async () => {
        const email = get('auth-email').value.trim();
        const pass = get('auth-pass').value.trim();
        const name = get('auth-name').value.trim();
        const errBox = get('auth-error');
        
        if(!email || !pass) return (errBox.textContent = "All fields required", errBox.style.display = 'block');
        
        get('auth-btn').textContent = "Please wait...";
        get('auth-btn').disabled = true;
        
        try {
            if(isLoginMode) {
                await signInWithEmailAndPassword(auth, email, pass);
            } else {
                if(!name) throw new Error("Name required");
                isSigningUp = true;
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const newUser = {
                    uid: cred.user.uid, displayName: name, email: email,
                    pingId: 'pm_' + Math.random().toString(36).substr(2, 6),
                    photoURL: null, bio: '', phone: '', createdAt: serverTimestamp(),
                    status: 'offline', blockedUsers: []
                };
                await setDoc(doc(db, USERS_PATH, cred.user.uid), newUser);
                await updateProfile(cred.user, { displayName: name });
                await sendEmailVerification(cred.user);
                await signOut(auth);
                isSigningUp = false;
                alert("Account created! Check email to verify.");
                location.reload();
            }
        } catch(e) {
            errBox.textContent = e.message;
            errBox.style.display = 'block';
            get('auth-btn').textContent = isLoginMode ? 'Sign In' : 'Sign Up';
            get('auth-btn').disabled = false;
        }
    });

    get('forgot-pass-btn').onclick = async () => {
        const email = get('auth-email').value;
        if(!email) return showToast("Enter your email address");
        try { await sendPasswordResetEmail(auth, email); showToast("Reset link sent"); } 
        catch(e) { showToast(e.message); }
    };

    // --- USER PROFILE & DATA ---
    async function loadUserProfile(uid) {
        const snap = await getDoc(doc(db, USERS_PATH, uid));
        if (snap.exists()) currentUserData = snap.data();
        else {
            currentUserData = { uid: uid, displayName: currentUser.displayName, blockedUsers: [], pingId: 'pm_' + Math.random().toString(36).substr(2, 6) };
            await setDoc(doc(db, USERS_PATH, uid), currentUserData);
        }
        updateHeaderUI();
    }

    function updateHeaderUI() {
        const name = currentUserData.displayName || 'User';
        const photo = currentUserData.photoURL;
        // Header
        if(photo) { get('header-avatar-img').src=photo; get('header-avatar-img').style.display='block'; get('header-avatar-text').style.display='none'; }
        else { get('header-avatar-img').style.display='none'; get('header-avatar-text').textContent=name[0].toUpperCase(); get('header-avatar-text').style.display='block'; }
        // Profile View
        get('current-user-display-name').textContent = name;
        get('my-ping-id').textContent = '@' + currentUserData.pingId;
        get('edit-name').value = name;
        get('edit-bio').value = currentUserData.bio || '';
        get('edit-phone').value = currentUserData.phone || '';
        get('edit-email').value = currentUser.email;
        if(photo) { get('profile-img-preview').src = photo; get('profile-img-preview').style.display='block'; get('profile-initial-preview').style.display='none'; }
    }

    // --- NAVIGATION ---
    get('profile-header-btn').onclick = () => showView('view-profile');
    get('nav-chats').onclick = () => showView('view-home');
    get('nav-find').onclick = () => { showView('view-find'); loadSearchHistory(); };
    get('nav-profile').onclick = () => showView('view-profile');
    get('back-from-find').onclick = () => showView('view-home');
    get('back-from-profile').onclick = () => showView('view-home');
    get('logout-btn').onclick = () => { updatePresence('offline'); signOut(auth); };
    get('back-from-friend-profile').onclick = () => showView('view-chat');
    
    // Theme
    get('theme-toggle').addEventListener('change', (e) => {
        document.body.setAttribute('data-theme', e.target.checked ? 'dark' : 'light');
    });

    // --- HOME: CHAT LIST ---
    function loadChatList() {
        if(unsubscribeChats) unsubscribeChats();
        const ref = collection(db, CHATS_PATH);
        unsubscribeChats = onSnapshot(ref, (snapshot) => {
            const list = get('chat-list-container');
            list.innerHTML = '';
            let hasChats = false;
            const rooms = [];
            
            snapshot.forEach(d => {
                const room = d.data();
                if(room.participants && room.participants.includes(currentUser.uid)) {
                    if(room.hiddenFor && room.hiddenFor.includes(currentUser.uid)) return;
                    rooms.push({ id: d.id, ...room });
                }
            });
            rooms.sort((a,b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));

            rooms.forEach(room => {
                hasChats = true;
                const pid = room.participants.find(id => id !== currentUser.uid);
                const info = room.participantInfo?.[pid] || { displayName: 'User', photoURL: null };
                
                let lastTxt = room.lastMessage?.text || 'No messages';
                if(room.lastMessage?.type === 'image') lastTxt = 'ðŸ“· Photo';
                if(room.lastMessage?.type === 'deleted') lastTxt = 'ðŸš« Message deleted';

                const time = room.lastMessage?.timestamp ? new Date(room.lastMessage.timestamp.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
                
                const card = document.createElement('div');
                card.className = 'user-card';
                card.innerHTML = `
                   <div class="avatar-wrapper">
                      <div class="avatar">${info.photoURL ? `<img src="${info.photoURL}">` : info.displayName[0].toUpperCase()}</div>
                      <div class="status-dot" id="dot-${room.id}"></div>
                   </div>
                   <div class="card-info">
                      <div class="card-top"><span class="card-name">${info.displayName}</span><span class="card-time">${time}</span></div>
                      <div class="card-msg">${lastTxt}</div>
                   </div>
                `;
                
                // LONG PRESS FOR CHAT OPTIONS
                addLongPress(card, () => {
                    openActionSheet([
                         { text: "Delete Chat (For me)", class: "danger", action: () => deleteChatForMe(room.id) },
                         { text: "Cancel", action: hideActionSheet }
                    ]);
                }, () => openChat(pid, info));

                list.appendChild(card);
                
                getDoc(doc(db, USERS_PATH, pid)).then(s => {
                    if(s.exists() && s.data().status === 'online') get(`dot-${room.id}`).classList.add('online');
                });
            });

            if(!hasChats) list.innerHTML = `<div style="text-align:center; padding:50px 20px; color:var(--text-muted);">No chats.<br>Go to <b>Search</b> to find friends.</div>`;
        });
    }

    // --- CHAT ROOM ---
    async function openChat(pid, pData) {
        currentPartnerId = pid;
        currentPartnerData = pData;
        
        // Fetch fresh data if needed
        if(!pData.photoURL) {
            const snap = await getDoc(doc(db, USERS_PATH, pid));
            if(snap.exists()) currentPartnerData = snap.data();
        }

        const uids = [currentUser.uid, pid].sort();
        currentChatId = uids.join('_');
        
        get('chat-header-name').textContent = currentPartnerData.displayName;
        if(currentPartnerData.photoURL) { get('chat-header-img').src=currentPartnerData.photoURL; get('chat-header-img').style.display='block'; get('chat-header-initial').style.display='none'; }
        else { get('chat-header-img').style.display='none'; get('chat-header-initial').textContent=currentPartnerData.displayName[0]; get('chat-header-initial').style.display='block'; }
        
        // Reset status text
        get('chat-header-status').textContent = 'Connecting...';
        get('chat-header-status').style.color = 'var(--text-muted)';

        showView('view-chat');
        listenToRoom(currentChatId);
        loadMessages(currentChatId);
    }
    
    get('chat-back-btn').onclick = () => {
        if(unsubscribeMsgs) unsubscribeMsgs();
        if(unsubscribeRoom) unsubscribeRoom();
        if(unsubscribePartnerStatus) unsubscribePartnerStatus();
        showView('view-home');
        currentChatId = null;
    };
    
    // View Friend Profile from Header (FIXED: Fetch full data to get PingID)
    get('chat-user-header').onclick = async () => {
        showView('view-friend-profile');
        
        // Fetch full profile data to ensure we have PingID
        let fullData = currentPartnerData;
        try {
            const snap = await getDoc(doc(db, USERS_PATH, currentPartnerId));
            if (snap.exists()) {
                fullData = snap.data();
                // Update local cache
                currentPartnerData = { ...currentPartnerData, ...fullData };
            }
        } catch(e) { console.log("Could not fetch full profile"); }

        // Update Friend View
        get('friend-display-name').textContent = fullData.displayName;
        get('friend-ping-id').textContent = '@' + (fullData.pingId || 'unknown');
        get('friend-bio').textContent = fullData.bio || 'No bio available';
        get('friend-email').textContent = fullData.email || 'Hidden';
        
        const img = get('friend-img-preview');
        const txt = get('friend-initial-preview');
        if(fullData.photoURL) { img.src=fullData.photoURL; img.style.display='block'; txt.style.display='none'; }
        else { img.style.display='none'; txt.style.display='flex'; txt.textContent = (fullData.displayName||'U')[0]; }

        const isBlocked = currentUserData.blockedUsers?.includes(currentPartnerId);
        const btn = get('friend-block-btn');
        btn.textContent = isBlocked ? "Unblock User" : "Block User";
        btn.onclick = () => toggleBlock(currentPartnerId, !isBlocked);
    };

    async function toggleBlock(uid, shouldBlock) {
        const ref = doc(db, USERS_PATH, currentUser.uid);
        if(shouldBlock) {
            await updateDoc(ref, { blockedUsers: arrayUnion(uid) });
            currentUserData.blockedUsers.push(uid);
            showToast("Blocked User");
            get('friend-block-btn').textContent = "Unblock User";
        } else {
            await updateDoc(ref, { blockedUsers: arrayRemove(uid) });
            currentUserData.blockedUsers = currentUserData.blockedUsers.filter(x=>x!==uid);
            showToast("Unblocked User");
            get('friend-block-btn').textContent = "Block User";
        }
    }

    function listenToRoom(rid) {
        if(unsubscribeRoom) unsubscribeRoom();
        if(unsubscribePartnerStatus) unsubscribePartnerStatus();
        
        const rRef = doc(db, CHATS_PATH, rid);
        updateDoc(rRef, { hiddenFor: arrayRemove(currentUser.uid) }).catch(()=>{});

        unsubscribeRoom = onSnapshot(rRef, (snap) => {
            if(!snap.exists()) return;
            const data = snap.data();
            get('typing-indicator').style.display = (data.typing && data.typing[currentPartnerId]) ? 'block' : 'none';
        });

        // *** UPDATED STATUS LOGIC FOR REAL-TIME / TIME AGO ***
        unsubscribePartnerStatus = onSnapshot(doc(db, USERS_PATH, currentPartnerId), (snap) => {
             if(snap.exists()) {
                 const u = snap.data();
                 const statusEl = get('chat-header-status');
                 
                 // Online Check
                 if(u.status === 'online') { 
                     statusEl.textContent = 'Active Now'; 
                     statusEl.style.color = '#4CD964'; 
                 }
                 else { 
                     // Time Ago Logic
                     statusEl.style.color = 'var(--text-muted)';
                     if (u.lastActive) {
                        statusEl.textContent = "Active " + formatTimeAgo(u.lastActive.toDate());
                     } else {
                        statusEl.textContent = 'Offline'; 
                     }
                 }
                 
                 // Block Logic
                 const banner = get('blocked-banner');
                 const inputArea = get('input-area-wrapper');
                 if(u.blockedUsers?.includes(currentUser.uid)) {
                     banner.textContent = "You have been blocked by this user."; banner.style.display = 'block'; inputArea.style.display = 'none';
                 } else if (currentUserData.blockedUsers?.includes(currentPartnerId)) {
                     banner.innerHTML = `You blocked this user. <span style="text-decoration:underline; cursor:pointer;" onclick="window.quickUnblock()">Unblock</span>`; 
                     banner.style.display = 'block'; inputArea.style.display = 'none';
                     window.quickUnblock = () => toggleBlock(currentPartnerId, false);
                 } else {
                     banner.style.display = 'none'; inputArea.style.display = 'block';
                 }
             }
        });
    }

    function loadMessages(rid) {
        const ref = collection(db, CHATS_PATH, rid, 'messages');
        const list = get('messages');
        
        unsubscribeMsgs = onSnapshot(ref, (snap) => {
            list.innerHTML = '';
            const msgs = [];
            snap.forEach(d => msgs.push({id: d.id, ...d.data()}));
            msgs.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
            
            let lastDate = null;
            
            msgs.forEach((m, i) => {
                if(m.deletedFor && m.deletedFor.includes(currentUser.uid)) return;

                const date = m.timestamp ? new Date(m.timestamp.seconds * 1000) : new Date();
                const dStr = date.toDateString();
                if(dStr !== lastDate) {
                    list.innerHTML += `<div class="date-separator">${dStr}</div>`;
                    lastDate = dStr;
                }

                const isMe = m.senderId === currentUser.uid;
                const row = document.createElement('div');
                row.className = `msg-row ${isMe ? 'me' : 'you'}`;
                
                let content = m.text;
                if(m.type === 'image') content = `<img src="${m.text}" class="chat-img" onclick="window.viewImg('${m.text}')">`;
                if(m.type === 'deleted') { content = '<span style="font-style:italic; opacity:0.6;">ðŸš« Message deleted</span>'; }
                
                let replyHTML = '';
                if(m.replyTo) {
                    replyHTML = `<div style="border-left:2px solid var(--primary); padding-left:6px; margin-bottom:4px; font-size:11px; opacity:0.8;">
                       <div style="font-weight:700">${m.replyTo.name}</div>
                       <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${m.replyTo.text}</div>
                    </div>`;
                }
                
                row.innerHTML = `
                   <div class="msg-bubble">
                      ${replyHTML}
                      ${content}
                      <div class="msg-meta">${date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                   </div>
                `;
                
                // LONG PRESS MESSAGE ACTIONS
                addLongPress(row.querySelector('.msg-bubble'), () => {
                    if(m.type === 'deleted') return;
                    const opts = [];
                    opts.push({ text: "Reply", action: () => initReply(m) });
                    opts.push({ text: "Copy Text", action: () => { navigator.clipboard.writeText(m.text); showToast("Copied"); hideActionSheet(); }});
                    
                    if(isMe) {
                        opts.push({ text: "Delete for Everyone", class:"danger", action: () => deleteMsg(rid, m.id, 'everyone') });
                        opts.push({ text: "Delete for Me", class:"danger", action: () => deleteMsg(rid, m.id, 'me') });
                    }
                    opts.push({ text: "Cancel", action: hideActionSheet });
                    openActionSheet(opts);
                });
                
                list.appendChild(row);
            });
            list.scrollTop = list.scrollHeight;
        });
    }

    // --- MESSAGE SENDING ---
    function initReply(m) {
        replyTo = { id: m.id, text: m.type==='image'?'Photo':m.text, name: m.senderId===currentUser.uid?'You':currentPartnerData.displayName };
        get('replyToName').textContent = replyTo.name;
        get('replyTextPreview').textContent = replyTo.text;
        get('replyPreview').classList.add('active');
        get('msg-input').focus();
        hideActionSheet();
    }
    get('cancelReply').onclick = () => { replyTo = null; get('replyPreview').classList.remove('active'); };

    async function sendMsg(txt, type='text') {
        if(!txt) return;
        const payload = {
            senderId: currentUser.uid, text: txt, type: type,
            status: 'sent', deletedFor: [], timestamp: serverTimestamp()
        };
        if(replyTo && type==='text') { payload.replyTo = replyTo; get('cancelReply').click(); }
        
        await addDoc(collection(db, CHATS_PATH, currentChatId, 'messages'), payload);
        await setDoc(doc(db, CHATS_PATH, currentChatId), {
            participants: [currentUser.uid, currentPartnerId],
            participantInfo: { 
                [currentUser.uid]: { displayName: currentUserData.displayName, photoURL: currentUserData.photoURL },
                [currentPartnerId]: { displayName: currentPartnerData.displayName, photoURL: currentPartnerData.photoURL }
            },
            lastMessage: payload, updatedAt: serverTimestamp(), hiddenFor: arrayRemove(currentPartnerId)
        }, {merge: true});
    }

    get('send-btn').onclick = () => { const t = get('msg-input').value.trim(); if(t) { sendMsg(t); get('msg-input').value=''; } };
    
    get('img-btn').onclick = () => get('img-input').click();
    get('img-input').onchange = async (e) => {
        const f = e.target.files[0]; if(!f) return;
        showToast("Sending...");
        const reader = new FileReader();
        reader.readAsDataURL(f);
        reader.onload = (ev) => {
            const img = new Image(); img.src = ev.target.result;
            img.onload = () => {
                const cvs = document.createElement('canvas');
                const scale = Math.min(800/img.width, 800/img.height, 1);
                cvs.width = img.width*scale; cvs.height = img.height*scale;
                cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                sendMsg(cvs.toDataURL('image/jpeg', 0.7), 'image');
            };
        };
    };

    // --- HELPERS: ACTION SHEET & LONG PRESS ---
    function openActionSheet(buttons) {
        const sheet = get('actionSheetContent');
        sheet.innerHTML = '<div class="sheet-header">Select Option</div>';
        buttons.forEach(b => {
            const btn = document.createElement('button');
            btn.className = `sheet-btn ${b.class || ''}`;
            btn.textContent = b.text;
            btn.onclick = b.action;
            sheet.appendChild(btn);
        });
        get('actionSheetOverlay').classList.add('active');
    }
    window.hideActionSheet = () => get('actionSheetOverlay').classList.remove('active');
    get('actionSheetOverlay').onclick = (e) => { if(e.target === get('actionSheetOverlay')) hideActionSheet(); };

    function addLongPress(el, onLong, onClick) {
        let timer;
        const start = () => { timer = setTimeout(() => { if(navigator.vibrate) navigator.vibrate(50); el.classList.add('long-press-active'); onLong(); }, 500); };
        const end = () => { clearTimeout(timer); el.classList.remove('long-press-active'); };
        el.addEventListener('touchstart', start, {passive:true}); el.addEventListener('touchend', end); el.addEventListener('touchmove', end);
        el.addEventListener('mousedown', start); el.addEventListener('mouseup', end);
        if(onClick) el.addEventListener('click', onClick);
    }
    
    // --- SEARCH (UPDATED UI) ---
    get('search-btn').onclick = async () => {
        const pid = get('search-ping-id').value.trim();
        const res = get('search-results'); res.innerHTML = 'Searching...';
        
        // Exact Match Query
        const q = query(collection(db, USERS_PATH), where("pingId", "==", pid));
        const snap = await getDocs(q);
        
        res.innerHTML = '';
        if(snap.empty) return (res.innerHTML = '<div style="text-align:center;color:var(--text-muted);">User not found.<br>Check PingID exactly (e.g. pm_AbCd12)</div>');
        
        snap.forEach(d => {
            const u = d.data();
            if(u.uid === currentUser.uid) return (res.innerHTML = '<div style="text-align:center;">That\'s your ID!</div>');
            
            // CARD UI FOR SEARCH RESULT
            const div = document.createElement('div');
            div.className = 'user-card search-result-card';
            div.innerHTML = `
                <div style="display:flex; align-items:center; gap:12px;">
                    <div class="avatar" style="width:40px; height:40px;">
                        ${u.photoURL ? `<img src="${u.photoURL}">` : u.displayName[0].toUpperCase()}
                    </div>
                    <div style="font-weight:600; font-size:15px;">${u.displayName}</div>
                </div>
                <button class="btn-msg-action">Message</button>
            `;
            
            // Click Handler
            div.onclick = () => { addToHistory(u); openChat(u.uid, u); };
            res.appendChild(div);
        });
    };
    function addToHistory(u) {
        const k = `history_${currentUser.uid}`;
        let h = JSON.parse(localStorage.getItem(k)||'[]');
        h = h.filter(x => x.uid !== u.uid); h.unshift(u);
        localStorage.setItem(k, JSON.stringify(h.slice(0,5)));
    }
    window.loadSearchHistory = () => {
        const k = `history_${currentUser.uid}`;
        const h = JSON.parse(localStorage.getItem(k)||'[]');
        const list = get('history-list'); list.innerHTML = '';
        h.forEach(u => {
            const el = document.createElement('div');
            el.innerHTML = `<div class="avatar" style="width:50px;height:50px;margin-bottom:4px;">${u.displayName[0]}</div><div style="font-size:10px;text-align:center;">${u.displayName.split(' ')[0]}</div>`;
            el.onclick = () => openChat(u.uid, u);
            list.appendChild(el);
        });
        get('search-history-section').style.display = h.length ? 'block' : 'none';
    };
    get('clear-history-btn').onclick = () => { localStorage.removeItem(`history_${currentUser.uid}`); loadSearchHistory(); };

    // --- PROFILE SAVE ---
    get('save-profile-btn').onclick = async () => {
        const btn = get('save-profile-btn'); btn.textContent = 'Saving...';
        await updateDoc(doc(db, USERS_PATH, currentUser.uid), {
            displayName: get('edit-name').value, bio: get('edit-bio').value, phone: get('edit-phone').value
        });
        showToast("Profile Saved");
        btn.textContent = 'Save Changes';
    };
    
    get('profile-file-input').onchange = async (e) => {
        const f = e.target.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.readAsDataURL(f);
        reader.onload = (ev) => {
            const img = new Image(); img.src = ev.target.result;
            img.onload = async () => {
                const cvs = document.createElement('canvas'); cvs.width=300; cvs.height=300;
                cvs.getContext('2d').drawImage(img,0,0,300,300);
                const url = cvs.toDataURL('image/jpeg',0.8);
                await updateDoc(doc(db, USERS_PATH, currentUser.uid), { photoURL: url });
                currentUserData.photoURL = url; updateHeaderUI(); showToast("Photo Updated");
            };
        };
    };

    // --- GLOBAL ---
    function updatePresence(status) {
        if(currentUser) updateDoc(doc(db, USERS_PATH, currentUser.uid), { status: status, lastActive: serverTimestamp() }).catch(()=>{});
    }
    document.addEventListener('visibilitychange', () => updatePresence(document.visibilityState === 'visible' ? 'online' : 'offline'));

    function listenGlobalMessages() {
        if(globalNotificationUnsubscribe) globalNotificationUnsubscribe();
        const q = query(collection(db, CHATS_PATH), where("participants", "array-contains", currentUser.uid));
        globalNotificationUnsubscribe = onSnapshot(q, (snap) => {
            snap.docChanges().forEach(change => {
                if(change.type === 'modified') {
                    const d = change.doc.data();
                    if(d.lastMessage?.senderId !== currentUser.uid && (Date.now() - d.updatedAt.seconds*1000 < 5000)) {
                         if(currentChatId !== change.doc.id && document.visibilityState==='hidden') {
                             new Notification("New Message", { body: d.lastMessage.text, icon: 'https://i.postimg.cc/RZ5FH16z/Gemini-Generated-Image-rgsqsqrgsqsqrgsq-removebg-preview.png' });
                         }
                    }
                }
            });
        });
    }
    
    async function deleteMsg(rid, mid, scope) {
        if(scope === 'everyone') {
             await updateDoc(doc(db, CHATS_PATH, rid, 'messages', mid), { type: 'deleted', text: 'deleted' });
             await updateDoc(doc(db, CHATS_PATH, rid), { 'lastMessage.type': 'deleted', 'lastMessage.text': 'deleted' });
        } else {
             await updateDoc(doc(db, CHATS_PATH, rid, 'messages', mid), { deletedFor: arrayUnion(currentUser.uid) });
        }
        hideActionSheet(); showToast("Deleted");
    }
    
    async function deleteChatForMe(rid) {
        await updateDoc(doc(db, CHATS_PATH, rid), { hiddenFor: arrayUnion(currentUser.uid) });
        hideActionSheet(); showToast("Chat Deleted");
    }

  </script>
</body>
</html>