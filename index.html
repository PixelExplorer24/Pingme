<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#ffffff"> 

  <title>PingMe Premium</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.2.js"></script>
  
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <style>
    /* --- MODERN CSS VARIABLES & RESET --- */
    :root {
      /* Palette (Light Mode Only) */
      --primary: #FF2D55; 
      --primary-grad: linear-gradient(135deg, #FF2D55 0%, #FF5C8A 100%);
      --bg-body: #F2F2F7;
      --bg-card: #FFFFFF;
      --bg-input: #E9E9EB;
      --text-main: #000000;
      --text-muted: #8E8E93;
      --border: rgba(0,0,0,0.08);
      --glass: rgba(255, 255, 255, 0.95);
      
      /* Theme Color Fixed for Light Mode */
      --theme-color: #ffffff;

      /* Messages */
      --msg-me-bg: var(--primary-grad);
      --msg-me-text: #FFFFFF;
      --msg-you-bg: #E5E5EA;
      --msg-you-text: #000000;
      
      /* Utilities */
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
      --radius-md: 20px;
      
      /* --- SAFE AREA VARIABLES (DYNAMIC NOTCH HANDLING) --- */
      --notch-height: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 20px);
      
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    
    html, body {
      height: 100%; height: 100dvh;
      margin: 0; padding: 0;
      background: var(--bg-body); color: var(--text-main);
      overflow: hidden;
      position: fixed; width: 100%; font-size: 15px; line-height: 1.4;
      transition: background 0.3s, color 0.3s;
    }

    /* --- PREMIUM LOADER ANIMATION --- */
    .premium-splash-container {
      position: relative; width: 240px; height: 240px;
      display: flex; align-items: center; justify-content: center;
    }
    .splash-text {
      font-size: 32px; font-weight: 900;
      background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      z-index: 10; letter-spacing: -0.5px;
    }
    .splash-ring {
      position: absolute; border-radius: 50%; border: 3px solid transparent;
      box-shadow: 0 0 20px rgba(255, 45, 85, 0.08);
    }
    .splash-ring:nth-child(1) {
      width: 100%; height: 100%; border-top-color: var(--primary); border-right-color: var(--primary);
      animation: spin-cw 2.5s linear infinite;
    }
    .splash-ring:nth-child(2) {
      width: 75%; height: 75%; border-bottom-color: #FF5C8A; border-left-color: #FF5C8A;
      animation: spin-ccw 2s linear infinite;
    }
    @keyframes spin-cw { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes spin-ccw { 0% { transform: rotate(0deg); } 100% { transform: rotate(-360deg); } }

    .lds-dual-ring { display: inline-block; width: 60px; height: 60px; }
    .lds-dual-ring:after { content: " "; display: block; width: 48px; height: 48px; margin: 6px; border-radius: 50%; border: 5px solid var(--primary); border-color: var(--primary) transparent var(--primary) transparent; animation: lds-dual-ring 1.2s linear infinite; }
    @keyframes lds-dual-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* --- UTILITIES --- */
    .glass-panel {
      background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
    }
    .hidden { display: none !important; }
    
    /* --- VIEW MANAGEMENT --- */
    .view-section { 
      display: none; flex-direction: column; 
      height: 100%; height: 100dvh; width: 100%; 
      position: absolute; top:0; left:0; background: var(--bg-body);
      overflow: hidden;
    }
    .view-section.active { display: flex; animation: fadeIn 0.3s ease-out; z-index: 10; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.99); } to { opacity: 1; transform: scale(1); } }

    /* --- HEADER --- */
    header.app {
      display: flex; align-items: center; justify-content: space-between; 
      background: #FFFFFF; 
      padding-top: calc(var(--notch-height) + 12px);
      padding-bottom: 12px;
      padding-left: 16px;
      padding-right: 16px;
      height: auto; 
      min-height: 60px;
      z-index: 50; flex-shrink: 0;
      position: relative;
      border-bottom: 1px solid var(--border);
      box-shadow: 0 1px 3px rgba(0,0,0,0.02);
    }
    
    .header-title { font-weight: 700; font-size: 17px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #000000; }
    
    .icon-btn {
      background: transparent; border: none; color: var(--primary); 
      width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      transition: background 0.2s; cursor: pointer; padding: 0;
    }
    .icon-btn:active { background: rgba(0,0,0,0.05); }

    /* --- LISTS --- */
    .list-container {
      flex: 1; overflow-y: auto; padding: 10px 16px 100px; -webkit-overflow-scrolling: touch;
    }
    .user-card {
      display: flex; align-items: center; gap: 14px; padding: 12px;
      background: var(--bg-card); border-radius: var(--radius-md); margin-bottom: 10px;
      box-shadow: var(--shadow-sm); transition: transform 0.1s, box-shadow 0.2s;
      cursor: pointer; border: 1px solid transparent; user-select: none;
    }
    .user-card:active, .user-card.long-press-active { transform: scale(0.96); background: var(--bg-input); }
    
    .avatar-wrapper { position: relative; width: 48px; height: 48px; flex-shrink: 0; }
    .avatar { 
      width: 100%; height: 100%; border-radius: 50%; background: var(--bg-input); 
      object-fit: cover; display: flex; align-items: center; justify-content: center;
      font-weight: 700; color: var(--text-muted); font-size: 18px; overflow: hidden;
      border: 1px solid var(--border);
    }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .status-dot { 
      width: 12px; height: 12px; border-radius: 50%; background: #4CD964; 
      position: absolute; bottom: 0; right: 0; border: 2px solid var(--bg-card);
      display: none; box-shadow: 0 0 0 2px var(--bg-card);
    }
    .status-dot.online { display: block; animation: pulse 2s infinite; }
    
    .card-info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
    .card-top { display: flex; justify-content: space-between; align-items: center; }
    .card-name { font-weight: 600; font-size: 16px; color: var(--text-main); }
    .card-time { font-size: 12px; color: var(--text-muted); }
    .card-msg { font-size: 13px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .search-result-card { justify-content: space-between; }
    .btn-msg-action {
        background: var(--primary); color: white; border: none; padding: 6px 14px;
        border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer;
    }

    /* --- CHAT AREA FIXED --- */
    main.chat-view {
        flex: 1; display: flex; flex-direction: column; background: var(--bg-body); 
        position: relative; overflow: hidden; width: 100%;
        background-size: cover; background-position: center; background-repeat: no-repeat;
    }
    
    .messages-area {
        flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; 
        gap: 2px; 
        padding-bottom: 20px;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth; 
        transition: padding-bottom 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    .messages-area.typing-active {
        padding-bottom: 90px !important;
    }

    .date-separator {
        align-self: center; background: rgba(128,128,128,0.25); backdrop-filter: blur(4px); padding: 4px 12px;
        border-radius: 12px; font-size: 11px; font-weight: 600; color: var(--text-main); margin: 16px 0 8px;
    }
    .msg-row { display: flex; width: 100%; margin-bottom: 8px; position: relative; align-items: flex-end;}
    .msg-row.me { justify-content: flex-end; }
    .msg-row.you { justify-content: flex-start; }
    
    .msg-bubble {
      max-width: 75%; padding: 10px 14px; font-size: 15px; position: relative; word-wrap: break-word;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.1s; user-select: none;
    }
    .msg-bubble:active { transform: scale(0.98); }
    .msg-row.me .msg-bubble { background: var(--msg-me-bg); color: var(--msg-me-text); border-radius: 18px 4px 18px 18px; }
    .msg-row.you .msg-bubble { background: var(--msg-you-bg); color: var(--msg-you-text); border-radius: 4px 18px 18px 18px; }
    .msg-bubble img.chat-img { border-radius: 12px; max-width: 100%; display: block; margin-top: 4px; }
    
    .msg-bubble video.chat-video { border-radius: 12px; max-width: 100%; display: block; margin-top: 4px; }
    .msg-bubble audio.chat-audio { width: 200px; margin-top: 4px; border-radius: 20px; max-width: 100%; }
    
    .file-attachment {
        display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.1);
        padding: 8px 10px; border-radius: 12px; margin-top: 4px; text-decoration: none; color: inherit;
        transition: background 0.2s;
    }
    .msg-row.me .file-attachment { background: rgba(255,255,255,0.2); }
    .file-attachment:active { opacity: 0.7; }
    .file-icon {
        width: 32px; height: 32px; background: var(--bg-card); color: var(--primary);
        border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 10px;
        flex-shrink: 0; text-transform: uppercase;
    }
    .msg-row.me .file-icon { color: var(--primary); }
    .file-name { font-size: 13px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 140px; }

    .msg-meta { font-size: 9px; margin-top: 4px; opacity: 0.7; text-align: right; display: flex; justify-content: flex-end; align-items: center; gap:3px; }

    .status-tick { font-weight: 900; font-size: 10px; margin-left: 2px; }
    
    .seen-avatar {
        width: 16px; height: 16px; border-radius: 50%;
        margin-left: 4px; border: 1.5px solid var(--bg-body);
        animation: dropIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        object-fit: cover;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    @keyframes dropIn {
        from { opacity: 0; transform: translateY(-10px) scale(0.8); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .heart-reaction {
      position: absolute; bottom: -6px; right: -4px; font-size: 14px; background: #fff; border-radius: 50%;
      width: 22px; height: 22px; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15); z-index: 5;
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid rgba(0,0,0,0.05);
    }
    @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

    /* --- TYPING INDICATOR --- */
    .typing-bubble-container {
        position: absolute; 
        bottom: 100%;
        left: 20px; 
        z-index: 50;
        display: none; 
        animation: slideUpFade 0.3s ease-out;
        pointer-events: none;
        margin-bottom: 8px;
    }
    .typing-bubble-container.active { display: block; }
    @keyframes slideUpFade { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

    .typing-bubble {
        background: var(--bg-input); padding: 12px 16px; border-radius: 18px 18px 18px 4px;
        box-shadow: var(--shadow-sm); display: flex; gap: 4px; align-items: center; height: 38px;
        border: 1px solid var(--border);
    }
    .dot {
        width: 6px; height: 6px; background: #8E8E93; border-radius: 50%;
        animation: typingBounce 1.4s infinite ease-in-out both;
    }
    .dot:nth-child(1) { animation-delay: -0.32s; }
    .dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typingBounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    
    .chat-input-area {
      position: relative;
      flex-shrink: 0; background: var(--glass); backdrop-filter: blur(20px); border-top: 1px solid var(--border);
      padding: 10px 16px; 
      padding-bottom: var(--safe-bottom);
      display: flex; flex-direction: column; gap: 8px; z-index: 60; width: 100%;
    }
    .input-wrapper {
      display: flex; align-items: flex-end; gap: 8px; background: var(--bg-input);
      border-radius: 24px; padding: 6px 6px 6px 12px; border: 1px solid transparent; transition: border 0.2s;
    }
    .input-wrapper:focus-within { border-color: var(--primary); background: var(--bg-card); }
    textarea.chat-box, input.chat-box {
      flex: 1; background: transparent; border: none; font-size: 15px; color: var(--text-main);
      resize: none; max-height: 120px; padding: 10px 0; line-height: 20px;
    }
    .btn-send {
      width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: white;
      border: none; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(255, 45, 85, 0.4); transition: transform 0.1s; margin-bottom: 2px;
    }
    .btn-send:active { transform: scale(0.9); }
    
    .reply-preview {
      display: none; align-items: center; justify-content: space-between;
      padding: 8px 12px; background: var(--bg-input); border-radius: 12px; font-size: 12px;
      border-left: 3px solid var(--primary); margin-bottom: 4px;
    }
    .reply-preview.active { display: flex; }

    /* --- RECORDING UI --- */
    #recording-overlay {
        position: absolute; inset: 0; background: linear-gradient(90deg, #FF3B30 0%, #FF9500 100%); z-index: 10;
        display: none; align-items: center; justify-content: space-between;
        padding: 0 20px; border-radius: 24px; color: white;
        box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4);
    }
    #recording-overlay.active { display: flex; animation: slideInRight 0.2s ease-out; }
    @keyframes slideInRight { from{transform: translateX(20px); opacity: 0;} to{transform: translateX(0); opacity: 1;} }
    
    .recording-dot {
        width: 12px; height: 12px; border-radius: 50%; background: white;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.6);
        animation: pulseWhite 1s infinite;
    }
    @keyframes pulseWhite { 0%{transform:scale(1); opacity:1;} 50%{transform:scale(1.4); opacity:0.7;} 100%{transform:scale(1); opacity:1;} }

    .mic-active { 
        transform: scale(1.3) !important; 
        color: white !important; 
        background: #FF3B30 !important;
        box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7);
        animation: sonarWave 1.5s infinite cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    @keyframes sonarWave {
        0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); }
        70% { box-shadow: 0 0 0 20px rgba(255, 59, 48, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); }
    }

    /* --- BOTTOM NAV --- */
    .bottom-nav {
      position: absolute; bottom: 0; width: 100%; height: calc(60px + env(safe-area-inset-bottom));
      background: var(--glass); backdrop-filter: blur(20px); border-top: 1px solid var(--border);
      display: flex; justify-content: space-around; 
      padding-bottom: var(--safe-bottom);
      z-index: 100;
    }
    .nav-item {
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: var(--text-muted); gap: 4px; cursor: pointer; transition: color 0.2s;
    }
    .nav-item.active { color: var(--primary); }
    .nav-item svg { width: 24px; height: 24px; }
    .nav-label { font-size: 10px; font-weight: 500; }

    /* --- PROFILE & SETTINGS --- */
    .profile-container { padding: 20px; padding-bottom: 100px; overflow-y: auto; height: 100%; }
    .large-avatar-box {
      width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 16px;
      position: relative; box-shadow: var(--shadow-lg); background: var(--bg-card);
    }
    .large-avatar-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
    .cam-badge {
      position: absolute; bottom: 0; right: 0; background: var(--primary); color: white;
      width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      border: 3px solid var(--bg-body); cursor: pointer;
    }
    .settings-group {
      background: var(--bg-card); border-radius: 16px; padding: 0 16px; margin-bottom: 20px; box-shadow: var(--shadow-sm);
    }
    .settings-item {
      padding: 16px 0; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border);
    }
    .settings-item:last-child { border-bottom: none; }
    .settings-label { font-size: 15px; font-weight: 500; }
    .settings-input { border: none; background: transparent; text-align: right; font-size: 15px; color: var(--text-muted); width: 60%; }

    .switch { position: relative; width: 50px; height: 30px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; inset: 0; background: #E9E9EB; border-radius: 30px; transition: .4s; cursor: pointer; }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background: white; border-radius: 50%; transition: .4s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    input:checked + .slider { background: var(--primary); }
    input:checked + .slider:before { transform: translateX(20px); }

    /* --- AUTH --- */
    .auth-wrap {
      padding: 40px 30px; display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100%; text-align: center; overflow-y: auto;
    }
    .auth-card { width: 100%; max-width: 400px; }
    .input-field {
      width: 100%; padding: 16px; margin: 8px 0; border-radius: 16px; border: 1px solid var(--border);
      background: var(--bg-input); color: var(--text-main); font-size: 16px; transition: border 0.2s;
    }
    .input-field:focus { border-color: var(--primary); background: var(--bg-card); }
    .btn-primary {
      width: 100%; padding: 16px; margin-top: 16px; border-radius: 16px; border: none;
      background: var(--primary-grad); color: white; font-size: 16px; font-weight: 600;
      box-shadow: 0 8px 20px rgba(255, 45, 85, 0.25); cursor: pointer; transition: transform 0.1s;
      display: flex; align-items: center; justify-content: center;
    }
    .btn-primary:active { transform: scale(0.98); }
    
    .spring-spinner {
        width: 24px; height: 24px; border-radius: 50%;
        border: 3px solid rgba(255,255,255,0.3);
        border-top-color: white;
        animation: spring-spin 0.8s cubic-bezier(0.6, -0.28, 0.735, 0.045) infinite;
    }
    @keyframes spring-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


    /* --- ACTION SHEET --- */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
      z-index: 2000; opacity: 0; visibility: hidden; transition: 0.3s;
      display: flex; align-items: flex-end; justify-content: center;
    }
    .overlay.active { opacity: 1; visibility: visible; }
    .action-sheet {
      width: 100%; max-width: 500px; background: var(--bg-card);
      border-radius: 24px 24px 0 0; padding: 24px; transform: translateY(100%); 
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      box-shadow: var(--shadow-lg); display: flex; flex-direction: column; gap: 8px;
    }
    .overlay.active .action-sheet { transform: translateY(0); }
    .sheet-header { text-align: center; margin-bottom: 10px; color: var(--text-muted); font-size: 13px; font-weight: 600; }
    .sheet-btn {
      width: 100%; padding: 16px; border-radius: 16px; border: none; background: var(--bg-input);
      color: var(--text-main); font-size: 16px; font-weight: 600; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .sheet-btn.danger { background: rgba(255, 59, 48, 0.1); color: #FF3B30; }
    .sheet-btn:active { transform: scale(0.98); }

    /* --- TOAST --- */
    .toast {
      position: fixed; top: 40px; 
      left: 50%; transform: translateX(-50%) translateY(-100px);
      background: var(--glass); backdrop-filter: blur(20px); padding: 12px 24px;
      border-radius: 30px; box-shadow: var(--shadow-lg); border: 1px solid var(--border);
      font-weight: 600; color: var(--text-main); z-index: 3000; transition: 0.4s;
      display: flex; align-items: center; gap: 8px;
    }
    .toast.active { transform: translateX(-50%) translateY(0); }

    /* --- LIGHTBOX --- */
    #lightbox { 
      position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; 
      display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; 
    }
    #lightbox.active { opacity: 1; pointer-events: auto; }
    #lightbox img { max-width: 100%; max-height: 100%; transition: transform 0.1s; transform-origin: center; will-change: transform; }

    /* --- CALL UI STYLES --- */
    #view-call {
        position: fixed; inset: 0; background: #000; z-index: 9999;
        display: none; flex-direction: column;
        padding-top: calc(var(--notch-height) + 20px);
    }
    #view-call.active { display: flex; }
    
    #remote-video {
        width: 100%; height: 100%; object-fit: cover;
    }
    
    #local-video {
        position: absolute; top: calc(var(--notch-height) + 20px); right: 20px;
        width: 100px; height: 150px; background: #333;
        border-radius: 12px; overflow: hidden; border: 2px solid white;
        z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
    
    .call-controls {
        position: absolute; bottom: 40px; left: 0; width: 100%;
        display: flex; justify-content: center; gap: 20px; z-index: 100;
        padding-bottom: var(--safe-bottom);
    }
    
    .call-btn {
        width: 60px; height: 60px; border-radius: 50%; border: none;
        display: flex; align-items: center; justify-content: center;
        font-size: 24px; cursor: pointer; color: white;
        background: rgba(255,255,255,0.2); backdrop-filter: blur(10px);
        transition: transform 0.2s;
    }
    .call-btn:active { transform: scale(0.9); }
    .call-btn.end { background: #FF3B30; }
    .call-btn.muted { background: #fff; color: #000; }

    #incoming-call-modal {
        position: fixed; top: calc(var(--notch-height) + 20px); left: 20px; right: 20px;
        background: rgba(0,0,0,0.9); backdrop-filter: blur(20px);
        border-radius: 20px; padding: 20px; z-index: 10000;
        display: none; align-items: center; gap: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
        animation: slideDownCall 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes slideDownCall { from{transform:translateY(-100px);} to{transform:translateY(0);} }
    
    .incoming-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #4CD964; }
    .incoming-info { flex: 1; color: white; }
    .incoming-name { font-weight: 700; font-size: 16px; }
    .incoming-type { font-size: 12px; opacity: 0.7; color: #4CD964; }
    
    .incoming-actions { display: flex; gap: 10px; }
    .btn-accept { width: 40px; height: 40px; border-radius: 50%; background: #4CD964; border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .btn-reject { width: 40px; height: 40px; border-radius: 50%; background: #FF3B30; border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }

    /* --- REACTION STYLES --- */
    .reaction-overlay {
        position: absolute; bottom: -10px; right: 8px;
        background: var(--bg-card); border: 1px solid var(--border);
        border-radius: 12px; padding: 2px 4px; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-size: 12px; z-index: 10;
        min-width: 20px; height: 20px;
        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .reaction-bar {
        display: flex; gap: 15px; justify-content: center; padding: 12px;
        background: var(--bg-input); border-radius: 16px; margin-bottom: 8px;
    }
    .reaction-emoji {
        font-size: 24px; cursor: pointer; transition: transform 0.2s;
        user-select: none;
    }
    .reaction-emoji:active { transform: scale(1.4); }

    .twist-effect {
        animation: twist-n-shout 0.6s cubic-bezier(0.36, 0.07, 0.19, 0.97);
    }
    @keyframes twist-n-shout {
        0% { transform: rotate(0deg) scale(1); }
        25% { transform: rotate(3deg) scale(1.02); }
        50% { transform: rotate(-3deg) scale(1.02); }
        75% { transform: rotate(1deg) scale(1.01); }
        100% { transform: rotate(0deg) scale(1); }
    }
    
  </style>

</head>
<script>

  window.OneSignalDeferred = window.OneSignalDeferred || [];

  window.OneSignalDeferred.push(function(OneSignal) {

    OneSignal.init({

      appId: "6557f7d6-f574-4212-bfa1-629a9e1864be", // OneSignal ওয়েবসাইট থেকে পাওয়া ID

      safari_web_id: "web.onesignal.auto.xxxxx", // (অপশনাল) অ্যাপল ডিভাইসের জন্য

      notifyButton: {

        enable: true, // এটি স্ক্রিনে একটি লাল ঘণ্টা আইকন দেখাবে সাবস্ক্রাইব করার জন্য

      },

      allowLocalhostAsSecureOrigin: true, // লোকালহোস্টে টেস্ট করার জন্য

    });

  });

</script>
<body>

  <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto" hidden crossorigin="anonymous"></audio>
  <audio id="snd-btn-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" preload="auto" hidden crossorigin="anonymous"></audio>
  <audio id="snd-sent" src="https://assets.mixkit.co/active_storage/sfx/1606/1606-preview.mp3" preload="auto" hidden crossorigin="anonymous"></audio>
  <audio id="snd-seen" src="https://assets.mixkit.co/active_storage/sfx/571/571-preview.mp3" preload="auto" hidden crossorigin="anonymous"></audio>
  <audio id="snd-typing-click" src="https://assets.mixkit.co/active_storage/sfx/2364/2364-preview.mp3" preload="auto" hidden crossorigin="anonymous"></audio>
  <audio id="snd-partner-typing" src="https://cdn.freesound.org/previews/240/240566_3905081-lq.mp3" preload="auto" loop hidden crossorigin="anonymous"></audio>
  <audio id="snd-sweet-beep" src="https://assets.mixkit.co/active_storage/sfx/1862/1862-preview.mp3" preload="auto" hidden crossorigin="anonymous"></audio>
  <audio id="snd-ringtone" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" preload="auto" loop hidden crossorigin="anonymous"></audio>

  <div id="toastMsg" class="toast">
    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>
    <span id="toastText">Success</span>
  </div>

  <div id="splash-screen" style="position:fixed;inset:0;background:var(--bg-body);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 0.5s;">
    <div class="premium-splash-container">
        <div class="splash-ring"></div>
        <div class="splash-ring"></div>
        <div class="splash-text">PingMe</div>
    </div>
  </div>

  <div id="lightbox">
      <button id="lightbox-close" style="position:absolute;top:calc(var(--notch-height) + 20px);right:20px;background:rgba(255,255,255,0.2);color:white;border:none;border-radius:50%;width:40px;height:40px;font-size:24px;cursor:pointer;z-index:5001;">&times;</button>
      <img id="lightbox-img" src="">
  </div>

  <div id="actionSheetOverlay" class="overlay">
    <div class="action-sheet" id="actionSheetContent"></div>
  </div>

  <div id="view-call">
      <div id="remote-video"></div>
      <div id="local-video"></div>
      
      <div style="position:absolute; top:calc(var(--notch-height) + 40px); left:0; width:100%; text-align:center; color:white; z-index:10;">
          <h2 id="call-status-text" style="text-shadow:0 2px 4px rgba(0,0,0,0.5);">Connecting...</h2>
          <p id="call-partner-name-display" style="opacity:0.8;">User</p>
      </div>

      <div class="call-controls">
          <button class="call-btn" id="btn-toggle-mic">
              <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
          </button>
          <button class="call-btn end" id="btn-end-call">
              <svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
          <button class="call-btn" id="btn-toggle-cam">
              <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
          </button>
      </div>
  </div>

  <div id="incoming-call-modal">
      <img id="incoming-call-avatar" class="incoming-avatar" src="">
      <div class="incoming-info">
          <div class="incoming-name" id="incoming-call-name">User</div>
          <div class="incoming-type" id="incoming-call-type">Incoming Video Call...</div>
      </div>
      <div class="incoming-actions">
          <button class="btn-reject" id="btn-reject-incoming">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
          <button class="btn-accept" id="btn-accept-incoming">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
          </button>
      </div>
  </div>

  <div class="wrap" style="height:100%;">
      
      <div id="view-auth" class="view-section active">
          <div class="auth-wrap">
              <div class="auth-card">
                  <img src="https://i.postimg.cc/RZ5FH16z/Gemini-Generated-Image-rgsqsqrgsqsqrgsq-removebg-preview.png" width="80" style="margin-bottom:20px; border-radius:16px; box-shadow: 0 10px 20px rgba(255,45,85,0.2);">
                  <div style="font-size:48px; font-weight:900; margin-bottom:8px; color:var(--primary);">PingMe</div>
                  <p style="color:var(--text-muted); margin-bottom:30px;">Sign in to continue</p>

                  <div id="signup-fields" class="hidden">
                      <input id="auth-name" class="input-field" placeholder="Full Name" />
                  </div>
                  <input id="auth-email" class="input-field" placeholder="Email Address" type="email" />
                  <input id="auth-pass" class="input-field" placeholder="Password (6+ chars)" type="password" />
                  
                  <div id="auth-error" style="color:#FF3B30; font-size:13px; margin:10px 0; display:none;">Error</div>

                  <button id="auth-btn" class="btn-primary">Sign In</button>
                  <div id="forgot-pass-btn" style="margin-top:15px; color:var(--primary); font-weight:600; font-size:13px; cursor:pointer;">Forgot Password?</div>
                  <div id="auth-toggle" style="margin-top:20px; color:var(--text-muted); font-size:14px; cursor:pointer;">Don't have an account? <span style="color:var(--text-main); font-weight:600;">Sign Up</span></div>
              </div>
          </div>
      </div>

      <div id="view-home" class="view-section">
          <header class="app">
             <div class="header-title" style="font-size:22px; font-weight:800;">Chats</div>
             <button class="icon-btn" id="profile-header-btn">
                <div class="avatar" style="width:34px; height:34px;">
                    <img id="header-avatar-img" src="" style="display:none;">
                    <span id="header-avatar-text">U</span>
                </div>
             </button>
          </header>
          
          <div style="padding: 0 16px; margin-top: 20px; margin-bottom: 10px;">
              <div class="input-wrapper" style="background:var(--bg-input); padding: 8px 12px;">
                  <svg width="18" height="18" fill="none" stroke="var(--text-muted)" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                  <input id="home-search-input" class="chat-box" placeholder="Search message, name, ID..." style="height:auto; padding:0; margin-left:8px;">
              </div>
          </div>

          <div class="list-container" id="chat-list-container">
              <div style="text-align:center; padding:50px; color:var(--text-muted);">
                  <div class="lds-dual-ring" style="transform:scale(0.5);"></div>
                  <div>Loading Chats...</div>
              </div>
          </div>

          <nav class="bottom-nav">
              <div class="nav-item active" id="nav-chats">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                  <span class="nav-label">Chats</span>
              </div>
              <div class="nav-item" id="nav-find">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                  <span class="nav-label">Search</span>
              </div>
              <div class="nav-item" id="nav-profile">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                  <span class="nav-label">Profile</span>
              </div>
          </nav>
      </div>

      <div id="view-find" class="view-section" style="z-index: 20;">
          <header class="app">
              <button class="icon-btn" id="back-from-find">
                  <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
              </button>
              <div class="header-title">Find Friends</div>
          </header>
          <div class="profile-container">
             <div class="input-wrapper" style="margin-bottom:20px; background:var(--bg-card); padding:8px 16px;">
                 <input id="search-ping-id" class="chat-box" placeholder="Enter Ping ID (e.g. rahim1234)" style="height:auto;">
                 <button id="search-btn" class="icon-btn" style="background:var(--primary); color:white; width:32px; height:32px;">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                 </button>
             </div>
             
             <div id="search-history-section">
                <h4 style="margin:0 0 10px; font-size:13px; color:var(--text-muted); display:flex; justify-content:space-between;">
                    RECENT SEARCHES
                    <span id="clear-history-btn" style="color:#FF3B30; cursor:pointer;">Clear</span>
                </h4>
                <div id="history-list" style="display:flex; gap:15px; overflow-x:auto; padding-bottom:10px;"></div>
             </div>
             
             <div id="search-results" style="margin-top:20px;"></div>
          </div>
      </div>

      <div id="view-chat" class="view-section" style="z-index: 30;">
          <header class="app" style="justify-content: flex-start; gap: 10px;">
              <button class="icon-btn" id="chat-back-btn">
                  <svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
              </button>
              
              <div class="avatar" id="chat-header-avatar-container" style="width:36px; height:36px; border:1px solid var(--border);">
                   <img id="chat-header-img" src="" style="display:none;">
                   <span id="chat-header-initial">?</span>
              </div>

              <div id="chat-user-header" style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:flex-start; cursor:pointer;">
                  <div class="header-title" id="chat-header-name" style="font-size:16px;">User</div>
                  <div id="chat-header-status" style="font-size:11px; color:var(--text-muted); font-weight:500;">Offline</div>
              </div>

              <button class="icon-btn" id="btn-start-audio-call" style="width:32px; height:32px;">
                  <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
              </button>
              <button class="icon-btn" id="btn-start-video-call" style="width:32px; height:32px;">
                  <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
              </button>

          </header>
          
          <main class="chat-view">
              <div class="messages-area" id="messages"></div>
              
              <footer class="chat-input-area">
                <div id="typing-bubble" class="typing-bubble-container">
                  <div class="typing-bubble">
                      <div class="dot"></div>
                      <div class="dot"></div>
                      <div class="dot"></div>
                  </div>
                </div>

                <div id="blocked-banner" style="background:#FFE5E5; color:#FF3B30; padding:10px; text-align:center; border-radius:12px; font-size:13px; display:none; font-weight:600; margin-bottom:5px;"></div>
                
                <div id="input-area-wrapper">
                    <div class="reply-preview" id="replyPreview">
                        <div style="flex:1; overflow:hidden;">
                            <span style="color:var(--primary); font-weight:700;" id="replyToName">Name</span>
                            <div style="font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" id="replyTextPreview">Text</div>
                        </div>
                        <button id="cancelReply" style="background:none; border:none; color:var(--text-muted); font-size:20px;">&times;</button>
                    </div>

                    <div class="input-wrapper">
                        <input type="file" id="img-input" accept="image/*" hidden />
                        <input type="file" id="video-input" accept="video/*" hidden />
                        <input type="file" id="file-input" accept=".pdf,.doc,.docx,.txt,.zip" hidden />
                        
                        <div id="recording-overlay">
                            <div style="display:flex;align-items:center;gap:10px;">
                                <div class="recording-dot"></div>
                                <span id="recording-timer" style="font-weight:700; font-variant-numeric:tabular-nums; font-size:14px;">0:00</span>
                            </div>
                            <div style="font-size:11px; font-weight:600; opacity:0.9; text-transform:uppercase; letter-spacing:0.5px;">Recording... Release to Send</div>
                        </div>

                        <button class="icon-btn" id="img-btn" style="width:32px; height:32px; color:var(--text-muted);">
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </button>
                        <textarea id="msg-input" class="chat-box" rows="1" placeholder="iMessage"></textarea>
                        
                        <button class="icon-btn" id="mic-btn" style="width:32px; height:32px; margin-right:4px; transition:all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
                            <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                        </button>

                        <button class="btn-send" id="send-btn" style="display:none;">
                            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M12 5l7 7-7 7" /></svg>
                        </button>
                    </div>
                </div>
              </footer>
          </main>
      </div>

      <div id="view-profile" class="view-section" style="z-index: 20;">
          <header class="app">
              <button class="icon-btn" id="back-from-profile">
                  <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
              </button>
              <div class="header-title">My Profile</div>
          </header>
          
          <div class="profile-container">
              <div class="large-avatar-box">
                  <img id="profile-img-preview" class="large-avatar-img" src="" onclick="if(this.src) viewImg(this.src)">
                  <div id="profile-initial-preview" style="width:100%; height:100%; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:40px; font-weight:700; color:var(--text-muted);">U</div>
                  <label for="profile-file-input" class="cam-badge">
                      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  </label>
                  <input type="file" id="profile-file-input" hidden accept="image/*">
              </div>
              
              <div style="text-align:center; margin-bottom:20px;">
                  <h2 id="current-user-display-name" style="margin:0; font-size:22px;">Loading...</h2>
                  <div id="my-ping-id" style="color:var(--text-muted); font-size:13px; margin-top:4px;">@...</div>
              </div>

              <div class="settings-group">
                  <div class="settings-item">
                      <span class="settings-label">Sound Effects</span>
                      <label class="switch">
                          <input type="checkbox" id="sound-toggle" checked>
                          <span class="slider"></span>
                      </label>
                  </div>
                  <div class="settings-item" id="wallpaper-btn" style="cursor:pointer;">
                      <span class="settings-label">Chat Wallpaper</span>
                      <div style="display:flex;align-items:center;gap:6px;">
                           <span style="color:var(--text-muted); font-size:13px;">Change</span>
                           <svg width="16" height="16" fill="none" stroke="var(--text-muted)" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                      </div>
                  </div>
                  <input type="color" id="bg-color-input" hidden>
                  <input type="file" id="bg-img-input" hidden accept="image/*">
              </div>

              <div class="settings-group">
                  <div class="settings-item">
                      <span class="settings-label">Display Name</span>
                      <input id="edit-name" class="settings-input" placeholder="Your Name">
                  </div>
                  <div class="settings-item">
                      <span class="settings-label">Bio</span>
                      <input id="edit-bio" class="settings-input" placeholder="Add a bio...">
                  </div>
                  <div class="settings-item">
                      <span class="settings-label">Phone</span>
                      <input id="edit-phone" class="settings-input" type="tel" placeholder="Phone Number">
                  </div>
                  <div class="settings-item">
                      <span class="settings-label">Email</span>
                      <input id="edit-email" class="settings-input" disabled style="opacity:0.6;">
                  </div>
              </div>
              
              <button id="save-profile-btn" class="btn-primary" style="margin-top:0;">Save Changes</button>

              <div class="settings-group" style="margin-top: 20px; border: 1px solid rgba(255, 59, 48, 0.2); background: rgba(255, 59, 48, 0.05);">
                  <div class="settings-item" id="logout-btn" style="justify-content: center; cursor: pointer;">
                      <span style="color: #FF3B30; font-weight: 600;">Sign Out</span>
                  </div>
              </div>
          </div>
      </div>

      <div id="view-friend-profile" class="view-section" style="z-index: 40;">
          <header class="app">
              <button class="icon-btn" id="back-from-friend-profile">
                  <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
              </button>
              <div class="header-title">Friend's Profile</div>
          </header>
          
          <div class="profile-container">
              <div class="large-avatar-box" style="margin-bottom:10px;">
                  <img id="friend-img-preview" class="large-avatar-img" src="" onclick="if(this.src) viewImg(this.src)">
                  <div id="friend-initial-preview" style="width:100%; height:100%; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:40px; font-weight:700; color:var(--text-muted);">U</div>
              </div>
              
              <div style="text-align:center; margin-bottom:30px;">
                  <h2 id="friend-display-name" style="margin:0; font-size:22px;">Name</h2>
                  <div id="friend-ping-id" style="color:var(--text-muted); font-size:13px; margin-top:4px;">@...</div>
              </div>

              <div class="settings-group">
                  <div class="settings-item">
                      <span class="settings-label">Bio</span>
                      <span id="friend-bio" style="color:var(--text-muted);">...</span>
                  </div>
                  <div class="settings-item">
                      <span class="settings-label">Email</span>
                      <span id="friend-email" style="color:var(--text-muted);">...</span>
                  </div>
              </div>

              <button id="friend-block-btn" class="btn-primary" style="background:#FF3B30; margin-top:0;">Block User</button>
          </div>
      </div>

  </div> 

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, sendEmailVerification, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, query, collection, where, onSnapshot, serverTimestamp, increment, orderBy, limit, addDoc, arrayUnion, arrayRemove, deleteDoc, writeBatch, enableIndexedDbPersistence, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAOEmgVj-OzfVaZsNOn47WTdaCrb5h8h_s",
      authDomain: "ping-me-app-475d1.firebaseapp.com",
      databaseURL: "https://ping-me-app-475d1-default-rtdb.firebaseio.com",
      projectId: "ping-me-app-475d1",
      storageBucket: "ping-me-app-475d1.firebasestorage.app",
      messagingSenderId: "41337345094",
      appId: "1:41337345094:web:0a6f31fd1dd0a1f6026647",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- AGORA CONFIG ---
    const AGORA_APP_ID = "83291c0f69f64ba5a63c86e266c0b1c9"; 

    // --- ONESIGNAL INIT ---
    // Make sure to add OneSignalSDKWorker.js in root directory
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(function(OneSignal) {
        OneSignal.init({
            appId: "6557f7d6-f574-4212-bfa1-629a9e1864be", 
            safari_web_id: "web.onesignal.auto.6557f7d6-f574-4212-bfa1-629a9e1864be",
            notifyButton: {
                enable: true,
            },
        });
    });

    // --- PUSH NOTIFICATION SENDER FUNCTION (CLIENT-SIDE) ---
    async function sendPushNotification(targetUid, title, message) {
        const ONESIGNAL_APP_ID = "6557f7d6-f574-4212-bfa1-629a9e1864be";
        const ONESIGNAL_API_KEY = "os_v2_app_mvl7pvxvorbbfp5bmknj4gdexzq76zku4wweaquukcst6zkr4g2iyy5msdkwurvtlnd4ncgbxjr4rtwblj4pwndbhgv3zr5s3sber2i";

        const options = {
            method: 'POST',
            headers: {
                accept: 'application/json',
                'content-type': 'application/json',
                Authorization: 'Basic ' + ONESIGNAL_API_KEY
            },
            body: JSON.stringify({
                app_id: ONESIGNAL_APP_ID,
                // Using new aliases for v16 SDK targeting
                include_aliases: { "external_id": [targetUid] },
                target_channel: "push",
                contents: { "en": message },
                headings: { "en": title }
            })
        };

        try {
            await fetch('https://onesignal.com/api/v1/notifications', options);
            console.log("Push Notification Sent to", targetUid);
        } catch (err) {
            console.error('Push Error:', err);
        }
    }

    // --- PERSISTENCE ---
    enableIndexedDbPersistence(db).catch((err) => console.log("Persistence error:", err.code));

    const USERS_PATH = `artifacts/${firebaseConfig.projectId}/public/data/users`;
    const CHATS_PATH = `artifacts/${firebaseConfig.projectId}/public/data/chat_rooms`;

    // --- GLOBAL STATE ---
    let currentUser = null, currentUserData = null;
    let currentChatId = null, currentPartnerId = null, currentPartnerData = null;
    let unsubscribeChats, unsubscribeMsgs, unsubscribeRoom, unsubscribePartnerStatus, globalNotificationUnsubscribe;
    let isLoginMode = true, isSigningUp = false;
    let replyTo = null;
    let typingTimeout = null, isTyping = false;
    let isSoundEnabled = true;
    let msgLimit = 20;
    let wakeLock = null;

    // --- AUDIO RECORDING STATE ---
    let mediaRecorder = null, audioChunks = [], isRecording = false, recordStartTime = 0, recordInterval = null;

    // --- CALLING STATE (AGORA FIXED) ---
    let agoraClient = null;
    let localTracks = { video: null, audio: null };
    let isCallActive = false;
    let callTimerInterval = null;
    let callSeconds = 0;
    let currentCallType = 'audio'; // 'audio' or 'video'

    // --- UTILS ---
    const get = (id) => document.getElementById(id);
    const showToast = (msg) => {
        const t = get('toastMsg'); get('toastText').textContent = msg;
        t.classList.add('active'); setTimeout(() => t.classList.remove('active'), 2500);
    };

    // Auto-Scroll Feature
    function scrollToBottom() {
        const list = get('messages');
        setTimeout(() => {
            list.scrollTo({ top: list.scrollHeight, behavior: 'smooth' });
        }, 100);
    }

    // --- SYSTEM NOTIFICATIONS ---
    function sendSystemNotification(title, body) {
        if (!("Notification" in window)) return;
        if (Notification.permission === "granted") {
            new Notification(title, { body: body, icon: 'https://i.postimg.cc/RZ5FH16z/Gemini-Generated-Image-rgsqsqrgsqsqrgsq-removebg-preview.png' });
        }
    }

    // --- AUDIO SYSTEM ---
    let audioUnlocked = false;
    function initAudio() {
        if(audioUnlocked) return;
        ['notification-sound', 'snd-btn-click', 'snd-sent', 'snd-seen', 'snd-typing-click', 'snd-partner-typing', 'snd-sweet-beep', 'snd-ringtone'].forEach(id => {
            const el = document.getElementById(id);
            if(el) { el.volume = 0; el.play().then(() => { el.pause(); el.currentTime = 0; }).catch(() => {}); }
        });
        
        // Request Notification Permission on first interaction
        if ("Notification" in window && Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        audioUnlocked = true;
        document.removeEventListener('click', initAudio);
        document.removeEventListener('touchstart', initAudio);
    }
    document.addEventListener('click', initAudio);
    document.addEventListener('touchstart', initAudio);

    const playSound = (id, loop=false) => {
        if(!isSoundEnabled) return;
        const audio = document.getElementById(id);
        if (audio) {
            if(loop && !audio.paused) return;
            audio.loop = loop;
            audio.currentTime = 0; 
            if(id === 'snd-ringtone') audio.volume = 0.8;
            else if(id === 'snd-sweet-beep') audio.volume = 0.5;
            else audio.volume = 0.5;
            audio.play().catch(e => console.log("Sound blocked"));
        }
    };
    const stopSound = (id) => { const a = document.getElementById(id); if(a){ a.pause(); a.currentTime=0; }};

    // --- NAVIGATION & UI HANDLERS ---
    function showView(id) {
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
        get(id).classList.add('active');
        if(id === 'view-home' || id === 'view-find' || id === 'view-profile') {
           document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
           if(id === 'view-home') get('nav-chats').classList.add('active');
           if(id === 'view-find') get('nav-find').classList.add('active');
           if(id === 'view-profile') get('nav-profile').classList.add('active');
        }
        if(id==='view-chat') wakeLockRequest();
    }
    async function wakeLockRequest() { try { if('wakeLock' in navigator) wakeLock=await navigator.wakeLock.request('screen'); } catch(e){} }

    // Nav Listeners
    get('profile-header-btn').onclick = () => showView('view-profile');
    get('nav-chats').onclick = () => showView('view-home');
    get('nav-find').onclick = () => { showView('view-find'); loadSearchHistory(); };
    get('nav-profile').onclick = () => showView('view-profile');
    get('back-from-find').onclick = () => showView('view-home');
    get('back-from-profile').onclick = () => showView('view-home');
    get('chat-back-btn').onclick = () => {
        showView('view-home');
        if(unsubscribeMsgs) unsubscribeMsgs();
        if(unsubscribeRoom) unsubscribeRoom();
        stopSound('snd-partner-typing');
    };
    get('back-from-friend-profile').onclick = () => showView('view-chat');
    get('chat-user-header').onclick = async () => {
        showView('view-friend-profile');
        let fullData = currentPartnerData;
        try {
            const snap = await getDoc(doc(db, USERS_PATH, currentPartnerId));
            if (snap.exists()) { fullData = snap.data(); currentPartnerData = { ...currentPartnerData, ...fullData }; }
        } catch(e) {}
        get('friend-display-name').textContent = fullData.displayName;
        get('friend-ping-id').textContent = '@' + (fullData.pingId || 'unknown');
        get('friend-bio').textContent = fullData.bio || 'No bio available';
        get('friend-email').textContent = fullData.email || 'Hidden';
        const img = get('friend-img-preview'), txt = get('friend-initial-preview');
        if(fullData.photoURL) { img.src=fullData.photoURL; img.style.display='block'; txt.style.display='none'; }
        else { img.style.display='none'; txt.style.display='flex'; txt.textContent = (fullData.displayName||'U')[0]; }
        
        // Block Logic
        const isBlocked = currentUserData.blockedUsers?.includes(currentPartnerId);
        const btn = get('friend-block-btn');
        btn.textContent = isBlocked ? "Unblock User" : "Block User";
        btn.onclick = () => toggleBlock(currentPartnerId, !isBlocked);
    };

    async function toggleBlock(uid, shouldBlock) {
        const ref = doc(db, USERS_PATH, currentUser.uid);
        if(shouldBlock) {
            currentUserData.blockedUsers = currentUserData.blockedUsers || []; currentUserData.blockedUsers.push(uid);
            await updateDoc(ref, { blockedUsers: arrayUnion(uid) }); showToast("User Blocked");
        } else {
            currentUserData.blockedUsers = currentUserData.blockedUsers.filter(x => x !== uid);
            await updateDoc(ref, { blockedUsers: arrayRemove(uid) }); showToast("User Unblocked");
        }
        const btn = get('friend-block-btn');
        if(currentPartnerId === uid && btn) btn.textContent = shouldBlock ? "Unblock User" : "Block User";
        loadChatList();
        localStorage.setItem('cached_user_data', JSON.stringify(currentUserData));
    }

    // --- THEME & CACHE ---
    function checkCacheOnStartup() {
        const cachedUser = localStorage.getItem('cached_user_data');
        if (cachedUser) {
            try {
                currentUserData = JSON.parse(cachedUser);
                if(currentUserData.uid) {
                    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                    get('view-home').classList.add('active');
                    get('nav-chats').classList.add('active');
                    updateHeaderUI();
                    const cachedChats = localStorage.getItem('cached_chat_list');
                    if(cachedChats) renderChatList(JSON.parse(cachedChats));
                    get('splash-screen').style.opacity = 0;
                    setTimeout(() => get('splash-screen').classList.add('hidden'), 500);
                }
            } catch(e) {}
        }
    }
    checkCacheOnStartup();

    function initSettings() {
        if(localStorage.getItem('sound_enabled') === 'false') { isSoundEnabled = false; get('sound-toggle').checked = false; }
        else { isSoundEnabled = true; get('sound-toggle').checked = true; }
        initWallpaper();
    }
    
    function initWallpaper() {
        const savedBg = localStorage.getItem('chat_wallpaper');
        const mainView = get('view-chat').querySelector('main');
        if (savedBg) {
            if(savedBg.startsWith('#') || savedBg.startsWith('rgb')) {
                mainView.style.backgroundImage = 'none'; mainView.style.background = savedBg;
            } else {
                mainView.style.background = 'none'; mainView.style.backgroundImage = `url(${savedBg})`;
                mainView.style.backgroundSize = 'cover';
                mainView.style.backgroundPosition = 'center';
            }
        } else { mainView.style.background = ''; mainView.style.backgroundImage = ''; }
    }
    
    get('sound-toggle').addEventListener('change', (e) => { 
        const label = e.target.closest('.switch');
        if(label) {
            label.classList.add('twist-effect');
            setTimeout(() => label.classList.remove('twist-effect'), 600);
        }
        isSoundEnabled = e.target.checked; 
        localStorage.setItem('sound_enabled', isSoundEnabled); 
        if(isSoundEnabled) playSound('snd-btn-click');
    });
    
    get('wallpaper-btn').onclick = () => {
        openActionSheet([
            { text: "Choose Solid Color", action: () => { get('bg-color-input').click(); hideActionSheet(); } },
            { text: "Upload Image", action: () => { get('bg-img-input').click(); hideActionSheet(); } },
            { text: "Reset to Default", class: "danger", action: () => { localStorage.removeItem('chat_wallpaper'); initWallpaper(); showToast("Wallpaper Reset"); hideActionSheet(); }},
            { text: "Cancel", action: hideActionSheet }
        ]);
    };
    get('bg-color-input').addEventListener('input', (e) => { localStorage.setItem('chat_wallpaper', e.target.value); initWallpaper(); });
    get('bg-img-input').addEventListener('change', (e) => {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => { try { localStorage.setItem('chat_wallpaper', ev.target.result); initWallpaper(); } catch(e){ alert("Image too large"); } };
        reader.readAsDataURL(file);
    });

    // --- CALL TIMER LOGIC ---
    function startCallTimer() {
        callSeconds = 0;
        clearInterval(callTimerInterval);
        const statusEl = get('call-status-text');
        callTimerInterval = setInterval(() => {
            callSeconds++;
            const m = Math.floor(callSeconds / 60);
            const s = callSeconds % 60;
            statusEl.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }, 1000);
    }
    function stopCallTimer() { clearInterval(callTimerInterval); return callSeconds; }

    // --- AGORA LOGIC ---
    async function checkPermissions() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            stream.getTracks().forEach(track => track.stop());
            return true;
        } catch(e) {
            console.error("Permission Error:", e);
            alert("Please allow Camera and Microphone permissions in your browser settings to make calls.");
            return false;
        }
    }

    function initAgora() {
        if(agoraClient) return;
        agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
        agoraClient.on("user-published", async (user, mediaType) => {
            await agoraClient.subscribe(user, mediaType);
            if (mediaType === "video") { user.videoTrack.play("remote-video"); }
            if (mediaType === "audio") { user.audioTrack.play(); }
        });
        agoraClient.on("user-left", () => { showToast("Partner left the call"); endCall('ended_remote'); });
    }

    // Start Outgoing Call
    async function startCall(type) {
        if(!await checkPermissions()) return;
        
        currentCallType = type;
        get('view-call').classList.add('active');
        get('call-status-text').textContent = "Calling...";
        get('call-partner-name-display').textContent = currentPartnerData.displayName;
        get('local-video').style.display = type === 'video' ? 'block' : 'none';
        updateCallControlIcons();
        initAgora();

        // Send Push Notification for Call
        sendPushNotification(currentPartnerId, "Incoming Call", "📞 Incoming call from " + currentUserData.displayName);

        try {
            const uid = currentUser.uid;
            await agoraClient.join(AGORA_APP_ID, currentChatId, null, uid);
            localTracks.audio = await AgoraRTC.createMicrophoneAudioTrack();
            if (type === 'video') {
                localTracks.video = await AgoraRTC.createCameraVideoTrack();
                localTracks.video.play("local-video");
                await agoraClient.publish([localTracks.audio, localTracks.video]);
            } else { await agoraClient.publish([localTracks.audio]); }
            
            isCallActive = true;
            playSound('snd-ringtone', true); 

            await updateDoc(doc(db, CHATS_PATH, currentChatId), {
                callStatus: { state: 'calling', type: type, callerId: currentUser.uid, timestamp: Date.now() }
            });

            setTimeout(() => {
                if(isCallActive && get('call-status-text').textContent === "Calling...") {
                    showToast("No answer"); endCall('missed');
                }
            }, 45000); 
        } catch(e) { console.error(e); endCall('error'); }
    }

    // Accept Incoming Call
    async function acceptIncomingCall(callInfo) {
        if(!await checkPermissions()) return;
        stopSound('snd-ringtone');
        get('incoming-call-modal').style.display = 'none';
        
        currentCallType = callInfo.type;
        get('view-call').classList.add('active');
        get('call-partner-name-display').textContent = get('incoming-call-name').textContent; 
        get('local-video').style.display = currentCallType === 'video' ? 'block' : 'none';
        updateCallControlIcons();
        initAgora();

        try {
            await agoraClient.join(AGORA_APP_ID, callInfo.chatId, null, currentUser.uid);
            localTracks.audio = await AgoraRTC.createMicrophoneAudioTrack();
            if (currentCallType === 'video') {
                localTracks.video = await AgoraRTC.createCameraVideoTrack();
                localTracks.video.play("local-video");
                await agoraClient.publish([localTracks.audio, localTracks.video]);
            } else { await agoraClient.publish([localTracks.audio]); }

            isCallActive = true;
            startCallTimer();
            await updateDoc(doc(db, CHATS_PATH, callInfo.chatId), { 'callStatus.state': 'ongoing' });
        } catch(e) { console.error(e); endCall('error'); }
    }

    async function endCall(reason = 'ended_local') {
        stopSound('snd-ringtone');
        const duration = stopCallTimer();
        const m = Math.floor(duration / 60);
        const s = duration % 60;
        const timeStr = `${m}:${s.toString().padStart(2,'0')}`;

        if(localTracks.audio) { localTracks.audio.close(); localTracks.audio = null; }
        if(localTracks.video) { localTracks.video.close(); localTracks.video = null; }
        if(agoraClient) await agoraClient.leave();

        isCallActive = false;
        get('view-call').classList.remove('active');
        get('local-video').innerHTML = '';
        get('remote-video').innerHTML = '';
        get('btn-toggle-cam').style.background = 'rgba(255,255,255,0.2)';

        if(!currentChatId) return;

        let sysMsg = '';
        if (reason === 'missed') sysMsg = '📞 Missed Call';
        else if (reason === 'rejected') sysMsg = '📞 Call Rejected';
        else if (duration > 0) sysMsg = `📞 Call ended • ${timeStr}`;
        else sysMsg = '📞 Call ended';

        await updateDoc(doc(db, CHATS_PATH, currentChatId), { callStatus: { state: 'ended', timestamp: Date.now() } });
        
        if (reason === 'missed' || reason === 'rejected' || reason === 'ended_local') {
             await addDoc(collection(db, CHATS_PATH, currentChatId, 'messages'), {
                 text: sysMsg, type: 'text', senderId: currentUser.uid, timestamp: serverTimestamp(), status: 'sent', isSystem: true
             });
             await updateDoc(doc(db, CHATS_PATH, currentChatId), {
                 lastMessage: { text: sysMsg, type: 'text', timestamp: serverTimestamp(), senderId: currentUser.uid },
                 updatedAt: serverTimestamp()
             });
        }
    }

    get('btn-toggle-cam').onclick = async () => {
        if (!isCallActive) return;
        if (localTracks.video) {
            const isMuted = localTracks.video.muted;
            await localTracks.video.setMuted(!isMuted);
            const btn = get('btn-toggle-cam');
            if (!isMuted) { btn.style.background = '#fff'; btn.style.color = '#000'; } 
            else { btn.style.background = 'rgba(255,255,255,0.2)'; btn.style.color = '#fff'; }
        } else {
            try {
                localTracks.video = await AgoraRTC.createCameraVideoTrack();
                localTracks.video.play("local-video");
                await agoraClient.publish([localTracks.video]);
                get('local-video').style.display = 'block';
                currentCallType = 'video';
                get('btn-toggle-cam').style.background = 'rgba(255,255,255,0.2)';
                get('btn-toggle-cam').style.color = '#fff';
            } catch (e) { showToast("Camera access failed"); }
        }
    };

    get('btn-toggle-mic').onclick = async () => {
        if(localTracks.audio) {
            const muted = localTracks.audio.muted;
            await localTracks.audio.setMuted(!muted);
            const btn = get('btn-toggle-mic');
            btn.style.background = !muted ? '#fff' : 'rgba(255,255,255,0.2)';
            btn.style.color = !muted ? '#000' : '#fff';
        }
    };

    function updateCallControlIcons() {
        get('btn-toggle-mic').style.background = 'rgba(255,255,255,0.2)'; get('btn-toggle-mic').style.color = '#fff';
        get('btn-toggle-cam').style.background = currentCallType === 'video' ? 'rgba(255,255,255,0.2)' : '#fff';
        get('btn-toggle-cam').style.color = currentCallType === 'video' ? '#fff' : '#000'; 
    }

    get('btn-start-audio-call').onclick = () => startCall('audio');
    get('btn-start-video-call').onclick = () => startCall('video');
    get('btn-end-call').onclick = () => endCall('ended_local');

    // Rejection Logic
    get('btn-reject-incoming').onclick = async () => {
        stopSound('snd-ringtone');
        get('incoming-call-modal').style.display = 'none';
        const callChatId = get('incoming-call-modal').getAttribute('data-chat-id');
        if(callChatId) {
            await updateDoc(doc(db, CHATS_PATH, callChatId), { callStatus: { state: 'rejected', timestamp: Date.now() } });
            await addDoc(collection(db, CHATS_PATH, callChatId, 'messages'), {
                 text: "📞 Call Rejected", type: 'text', senderId: currentUser.uid, timestamp: serverTimestamp()
            });
        }
    };

    // --- AUTH ---
    onAuthStateChanged(auth, async (user) => {
        const splash = get('splash-screen');
        if (user) {
            initSettings();
            
            // --- OneSignal Login ---
            // Links Firebase UID to OneSignal External ID
            OneSignalDeferred.push(async function(OneSignal) {
                await OneSignal.login(user.uid);
            });

            if (!user.emailVerified && !isSigningUp) {
                await signOut(auth);
                showToast("Verify email first.");
                showView('view-auth'); 
                splash.style.opacity = 0; setTimeout(()=>splash.classList.add('hidden'),500);
                return;
            }
            if(isSigningUp) return;
            currentUser = user;
            if(!currentUserData) await loadUserProfile(user.uid);
            else loadUserProfile(user.uid);
            showView('view-home');
            loadChatList();
            updatePresence('online');
            listenGlobalMessages();
            splash.style.opacity = 0; setTimeout(()=>splash.classList.add('hidden'),500);
        } else {
            currentUser = null; currentUserData = null;
            
            // OneSignal Logout
            OneSignalDeferred.push(function(OneSignal) {
                OneSignal.logout();
            });

            localStorage.removeItem('cached_user_data');
            showView('view-auth');
            splash.style.opacity = 0; setTimeout(()=>splash.classList.add('hidden'),500);
        }
    });

    // --- PROFILE & DATA ---
    async function loadUserProfile(uid) {
        const snap = await getDoc(doc(db, USERS_PATH, uid));
        if (snap.exists()) {
             currentUserData = snap.data();
             localStorage.setItem('cached_user_data', JSON.stringify(currentUserData));
        } else {
            const baseName = currentUser.displayName ? currentUser.displayName.replace(/[^a-zA-Z0-9]/g, '').substring(0, 4) : 'user';
            const fallbackId = baseName + Math.floor(1000 + Math.random() * 9000);
            currentUserData = { uid: uid, displayName: currentUser.displayName, blockedUsers: [], pingId: fallbackId };
            await setDoc(doc(db, USERS_PATH, uid), currentUserData);
        }
        updateHeaderUI();
    }

    function updateHeaderUI() {
        if(!currentUserData) return;
        const name = currentUserData.displayName || 'User';
        const photo = currentUserData.photoURL;
        if(photo) { get('header-avatar-img').src=photo; get('header-avatar-img').style.display='block'; get('header-avatar-text').style.display='none'; }
        else { get('header-avatar-img').style.display='none'; get('header-avatar-text').textContent=name[0]; get('header-avatar-text').style.display='block'; }
        get('current-user-display-name').textContent = name;
        get('my-ping-id').textContent = '@' + currentUserData.pingId;
        get('edit-name').value = name;
        get('edit-bio').value = currentUserData.bio || '';
        get('edit-phone').value = currentUserData.phone || '';
        get('edit-email').value = currentUser.email;
        if(photo) { get('profile-img-preview').src = photo; get('profile-img-preview').style.display='block'; get('profile-initial-preview').style.display='none'; }
    }
    
    get('save-profile-btn').onclick = async () => {
        const btn = get('save-profile-btn'); btn.textContent = 'Saving...';
        const newName = get('edit-name').value, newBio = get('edit-bio').value, newPhone = get('edit-phone').value;
        await updateDoc(doc(db, USERS_PATH, currentUser.uid), { displayName: newName, bio: newBio, phone: newPhone });
        
        const q = query(collection(db, CHATS_PATH), where("participants", "array-contains", currentUser.uid));
        const snaps = await getDocs(q);
        const batch = writeBatch(db);
        snaps.forEach(d => {
            batch.update(doc(db, CHATS_PATH, d.id), { [`participantInfo.${currentUser.uid}.displayName`]: newName });
        });
        await batch.commit();

        currentUserData.displayName = newName; currentUserData.bio = newBio; currentUserData.phone = newPhone;
        localStorage.setItem('cached_user_data', JSON.stringify(currentUserData));
        updateHeaderUI(); showToast("Profile Saved"); btn.textContent = 'Save Changes';
    };
    
    get('profile-file-input').onchange = async (e) => {
        const f = e.target.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.readAsDataURL(f);
        reader.onload = (ev) => {
            const img = new Image(); img.src = ev.target.result;
            img.onload = async () => {
                const cvs = document.createElement('canvas'); cvs.width=300; cvs.height=300;
                cvs.getContext('2d').drawImage(img,0,0,300,300);
                const url = cvs.toDataURL('image/jpeg',0.8);
                showToast("Uploading...");
                await updateDoc(doc(db, USERS_PATH, currentUser.uid), { photoURL: url });
                
                const q = query(collection(db, CHATS_PATH), where("participants", "array-contains", currentUser.uid));
                const snaps = await getDocs(q);
                const batch = writeBatch(db);
                snaps.forEach(d => { batch.update(doc(db, CHATS_PATH, d.id), { [`participantInfo.${currentUser.uid}.photoURL`]: url }); });
                await batch.commit();

                currentUserData.photoURL = url; localStorage.setItem('cached_user_data', JSON.stringify(currentUserData));
                updateHeaderUI(); showToast("Photo Updated");
            };
        };
    };

    // --- CHAT LIST ---
    function loadChatList() {
        if(unsubscribeChats) unsubscribeChats();
        unsubscribeChats = onSnapshot(collection(db, CHATS_PATH), (snapshot) => {
            const rooms = [];
            snapshot.forEach(d => {
                const room = d.data();
                if(room.participants && room.participants.includes(currentUser.uid)) {
                    if(room.hiddenFor && room.hiddenFor.includes(currentUser.uid)) return;
                    if(room.lastMessage && room.lastMessage.senderId !== currentUser.uid && room.lastMessage.status === 'sent') {
                        updateDoc(doc(db, CHATS_PATH, d.id), { 'lastMessage.status': 'delivered' });
                    }
                    rooms.push({ id: d.id, ...room });
                }
            });
            rooms.sort((a,b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
            localStorage.setItem('cached_chat_list', JSON.stringify(rooms));
            renderChatList(rooms);
        });
    }

    function renderChatList(rooms) {
        const list = get('chat-list-container');
        list.innerHTML = '';
        if(rooms.length === 0) list.innerHTML = `<div style="text-align:center; padding:50px 20px; color:var(--text-muted);">No chats.<br>Go to <b>Search</b> to find friends.</div>`;
        
        rooms.forEach(room => {
            const pid = room.participants.find(id => id !== currentUser.uid);
            if (!pid) return;
            const info = room.participantInfo?.[pid] || { displayName: 'User' };
            
            let lastTxt = room.lastMessage?.text || 'No messages';
            if(room.lastMessage?.type === 'image') lastTxt = '📷 Photo';
            if(room.lastMessage?.type === 'video') lastTxt = '🎥 Video';
            if(room.lastMessage?.type === 'file') lastTxt = '📄 File';
            if(room.lastMessage?.type === 'audio') lastTxt = '🎤 Voice';
            if(room.lastMessage?.type === 'deleted') lastTxt = '🚫 Deleted';
            
            let time = '';
            if(room.lastMessage?.timestamp) {
                let d; if(room.lastMessage.timestamp.seconds) d = new Date(room.lastMessage.timestamp.seconds * 1000); else d = new Date(room.lastMessage.timestamp);
                time = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            }
            
            const card = document.createElement('div');
            card.className = 'user-card';
            card.setAttribute('data-uid', pid);

            addLongPress(card, () => {
                const isBlocked = currentUserData.blockedUsers?.includes(pid);
                openActionSheet([
                     { text: "Delete Chat (For me)", class: "danger", action: () => deleteChatForMe(room.id) },
                     { text: isBlocked?"Unblock":"Block", class: isBlocked?"":"danger", action: () => { toggleBlock(pid, !isBlocked); hideActionSheet(); } },
                     { text: "Cancel", action: hideActionSheet }
                ]);
            }, () => openChat(pid, info));

            card.innerHTML = `
               <div class="avatar-wrapper">
                  <div class="avatar">${info.photoURL ? `<img src="${info.photoURL}">` : (info.displayName?info.displayName[0].toUpperCase():'U')}</div>
                  <div class="status-dot" id="dot-${room.id}"></div>
               </div>
               <div class="card-info">
                  <div class="card-top"><span class="card-name">${info.displayName}</span><span class="card-time">${time}</span></div>
                  <div class="card-msg">${lastTxt}</div>
               </div>
            `;
            list.appendChild(card);
            
            getDoc(doc(db, USERS_PATH, pid)).then(s => {
                if(s.exists()) {
                    const u = s.data();
                    const diff = (new Date() - (u.lastActive?.seconds?u.lastActive.seconds*1000:u.lastActive||0))/1000;
                    if(u.status === 'online' && diff < 180) { const dot = get(`dot-${room.id}`); if(dot) dot.classList.add('online'); }
                }
            });
        });
    }

    async function deleteChatForMe(rid) {
        await updateDoc(doc(db, CHATS_PATH, rid), { hiddenFor: arrayUnion(currentUser.uid) });
        hideActionSheet(); showToast("Chat Deleted");
    }

    function addLongPress(el, onLong, onClick) {
        let timer;
        const start = () => { timer = setTimeout(() => { if(navigator.vibrate) navigator.vibrate(50); el.classList.add('long-press-active'); onLong(); }, 500); };
        const end = () => { clearTimeout(timer); el.classList.remove('long-press-active'); };
        el.addEventListener('touchstart', start, {passive:true}); el.addEventListener('touchend', end); el.addEventListener('touchmove', end);
        el.addEventListener('mousedown', start); el.addEventListener('mouseup', end);
        if(onClick) el.addEventListener('click', onClick);
    }

    // --- CHAT ROOM ---
    window.openChat = async (partnerId, partnerInfo) => {
        currentPartnerId = partnerId;
        currentPartnerData = partnerInfo || { displayName: 'User' };
        currentChatId = [currentUser.uid, currentPartnerId].sort().join('_');

        get('chat-header-name').textContent = currentPartnerData.displayName;
        get('chat-header-img').src = currentPartnerData.photoURL || '';
        get('chat-header-img').style.display = currentPartnerData.photoURL ? 'block' : 'none';
        get('chat-header-initial').style.display = currentPartnerData.photoURL ? 'none' : 'block';
        get('chat-header-initial').textContent = (currentPartnerData.displayName||'U')[0];
        get('chat-header-status').textContent = 'Connecting...';
        
        showView('view-chat');
        msgLimit = 20;
        
        scrollToBottom();

        loadMessages(currentChatId);
        listenToRoom(currentChatId);
        
        const chatRef = doc(db, CHATS_PATH, currentChatId);
        const snap = await getDoc(chatRef);
        if (!snap.exists()) {
             await setDoc(chatRef, {
                 participants: [currentUser.uid, currentPartnerId],
                 participantInfo: {
                     [currentUser.uid]: { displayName: currentUserData.displayName, photoURL: currentUserData.photoURL },
                     [currentPartnerId]: { displayName: currentPartnerData.displayName, photoURL: currentPartnerData.photoURL }
                 }, updatedAt: serverTimestamp()
             });
        }
        updateChatUIForBlocks();
    };

    function updateChatUIForBlocks() {
        const banner = get('blocked-banner');
        const inputArea = get('input-area-wrapper');
        if (currentUserData.blockedUsers?.includes(currentPartnerId)) {
             banner.innerHTML = `You blocked this user. <span style="text-decoration:underline; cursor:pointer;" onclick="toggleBlock('${currentPartnerId}', false)">Unblock</span>`; 
             banner.style.display = 'block'; inputArea.style.display = 'none';
        } else {
             banner.style.display = 'none'; inputArea.style.display = 'block';
        }
    }

    function listenToRoom(rid) {
        if(unsubscribeRoom) unsubscribeRoom();
        if(unsubscribePartnerStatus) unsubscribePartnerStatus();
        
        unsubscribeRoom = onSnapshot(doc(db, CHATS_PATH, rid), (snap) => {
            if(!snap.exists()) return;
            const data = snap.data();
            
            const isPartnerTyping = data.typing && data.typing[currentPartnerId];
            const bubble = get('typing-bubble');
            const msgsArea = get('messages');
            
            if(isPartnerTyping) { 
                bubble.classList.add('active'); 
                msgsArea.classList.add('typing-active'); 
                scrollToBottom(); 
                playSound('snd-partner-typing', true);
            } else { 
                bubble.classList.remove('active'); 
                msgsArea.classList.remove('typing-active'); 
                stopSound('snd-partner-typing');
            }
            
            if(data.callStatus) {
                if(data.callStatus.state === 'ongoing' && get('call-status-text').textContent === "Calling...") {
                    stopSound('snd-ringtone'); startCallTimer();
                }
                if(data.callStatus.state === 'ended' && isCallActive) {
                    showToast("Call ended"); endCall('ended_remote');
                }
                if(data.callStatus.state === 'rejected' && isCallActive && get('call-status-text').textContent === "Calling...") {
                    showToast("Call rejected"); endCall('rejected');
                }
            }
        });

        unsubscribePartnerStatus = onSnapshot(doc(db, USERS_PATH, currentPartnerId), (snap) => {
            if(snap.exists()) {
                const u = snap.data();
                const diff = (new Date() - (u.lastActive?.seconds?u.lastActive.seconds*1000:u.lastActive||0))/1000;
                get('chat-header-status').textContent = (u.status === 'online' && diff < 180) ? 'Active Now' : 'Offline';
                if(u.status==='online' && diff < 180) get('chat-header-status').style.color = '#4CD964';
                else get('chat-header-status').style.color = 'var(--text-muted)';
            }
        });
    }

    // --- REACTION LOGIC ---
    async function toggleReaction(msgId, reactionType) {
        if (!currentChatId) return;
        const msgRef = doc(db, CHATS_PATH, currentChatId, 'messages', msgId);
        const snap = await getDoc(msgRef);
        if(!snap.exists()) return;
        
        const data = snap.data();
        const currentReactions = data.reactions || {};
        const myReaction = currentReactions[currentUser.uid];

        if(myReaction === reactionType) {
             await updateDoc(msgRef, { [`reactions.${currentUser.uid}`]: deleteField() });
        } else {
            await updateDoc(msgRef, { [`reactions.${currentUser.uid}`]: reactionType });
            playSound('snd-sweet-beep'); 
        }
    }

    function loadMessages(rid, isLoadMore = false) {
        if(unsubscribeMsgs) unsubscribeMsgs();
        const q = query(collection(db, CHATS_PATH, rid, 'messages'), orderBy('timestamp', 'desc'), limit(msgLimit));
        const list = get('messages');
        let prevScrollHeight = 0; if(isLoadMore) prevScrollHeight = list.scrollHeight;

        unsubscribeMsgs = onSnapshot(q, (snap) => {
            const wasAtBottom = (list.scrollHeight - list.scrollTop) <= (list.clientHeight + 150);
            
            snap.docChanges().forEach(change => {
                if(change.type==='added' && change.doc.data().senderId !== currentUser.uid) playSound('snd-sweet-beep');
                if(change.type==='modified' && change.doc.data().senderId === currentUser.uid && change.doc.data().status==='seen') playSound('snd-seen');
            });

            list.innerHTML = '';
            const msgs = [];
            snap.forEach(d => msgs.push({id:d.id, ...d.data()}));
            msgs.reverse();
            
            let lastDate = null;
            msgs.forEach(m => {
                if(m.deletedFor && m.deletedFor.includes(currentUser.uid)) return;
                
                if(m.senderId !== currentUser.uid && m.status !== 'seen') {
                    updateDoc(doc(db, CHATS_PATH, rid, 'messages', m.id), { status: 'seen' });
                }

                const date = m.timestamp ? new Date(m.timestamp.seconds * 1000) : new Date();
                const dStr = date.toDateString();
                if(dStr !== lastDate) { list.innerHTML += `<div class="date-separator">${dStr}</div>`; lastDate = dStr; }

                const isMe = m.senderId === currentUser.uid;
                const row = document.createElement('div');
                row.className = `msg-row ${isMe ? 'me' : 'you'}`;
                
                let content = m.text;
                if(m.type === 'image') content = `<img src="${m.text}" class="chat-img" onclick="viewImg('${m.text}')">`;
                else if(m.type === 'video') content = `<video src="${m.text}" class="chat-video" controls playsinline></video>`;
                else if(m.type === 'audio') content = `<audio src="${m.text}" class="chat-audio" controls controlsList="nodownload"></audio>`;
                else if(m.type === 'file') content = `<a href="${m.text}" download class="file-attachment"><div class="file-icon">FILE</div><div class="file-name">${m.fileName||'File'}</div></a>`;
                else if(m.type === 'deleted') content = '<span style="font-style:italic; opacity:0.6;">🚫 Deleted</span>';

                if(m.text.includes('📞')) {
                    row.className = 'msg-row';
                    row.style.justifyContent = 'center';
                    content = `<div style="background:rgba(128,128,128,0.2); padding:5px 12px; border-radius:12px; font-size:12px; margin:4px 0;">${m.text}</div>`;
                    row.innerHTML = content;
                } else {
                    let statusHTML = '';
                    if(isMe && m.type !== 'deleted') {
                         if(m.status === 'seen') {
                             const pPic = currentPartnerData.photoURL;
                             statusHTML = pPic ? `<img src="${pPic}" class="seen-avatar">` : `<div class="seen-avatar" style="background:#8E8E93;color:#fff;display:flex;align-items:center;justify-content:center;font-size:8px;">${(currentPartnerData.displayName||'U')[0]}</div>`;
                         } else if (m.status === 'delivered') statusHTML = '<span class="status-tick">✓✓</span>';
                         else statusHTML = '<span class="status-tick">✓</span>';
                    }
                    
                    let replyHTML = '';
                    if(m.replyTo) {
                        replyHTML = `<div style="border-left:2px solid var(--primary); padding-left:6px; margin-bottom:4px; font-size:11px; opacity:0.8;">
                           <div style="font-weight:700">${m.replyTo.name}</div>
                           <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${m.replyTo.text}</div>
                        </div>`;
                    }
                    
                    let reactionHTML = '';
                    if(m.reactions && Object.keys(m.reactions).length > 0) {
                        const reactionTypes = Object.values(m.reactions);
                        const distinct = [...new Set(reactionTypes)].slice(0, 3);
                        reactionHTML = `<div class="reaction-overlay">${distinct.join('')}${reactionTypes.length > 1 ? '<span style="font-size:9px;margin-left:2px;font-weight:700;">'+reactionTypes.length+'</span>' : ''}</div>`;
                    }

                    row.innerHTML = `<div class="msg-bubble">${replyHTML}${content}<div class="msg-meta">${date.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}${statusHTML}</div>${reactionHTML}</div>`;
                    
                    const bubble = row.querySelector('.msg-bubble');
                    
                    bubble.addEventListener('dblclick', (e) => {
                        e.stopPropagation(); e.preventDefault();
                        if(m.type === 'deleted') return;
                        toggleReaction(m.id, '❤️');
                        const heart = document.createElement('div');
                        heart.className = 'heart-reaction'; heart.textContent = '❤️';
                        bubble.appendChild(heart);
                        setTimeout(() => heart.remove(), 800);
                    });

                    addLongPress(bubble, () => {
                        if(m.type === 'deleted') return;
                        
                        const sheet = get('actionSheetContent'); sheet.innerHTML = '';
                        
                        const rBar = document.createElement('div');
                        rBar.className = 'reaction-bar';
                        ['❤️','👍','😂','😢','😡','🙏'].forEach(emoji => {
                            const sp = document.createElement('span'); 
                            sp.className = 'reaction-emoji'; sp.textContent = emoji;
                            sp.onclick = () => { toggleReaction(m.id, emoji); hideActionSheet(); };
                            rBar.appendChild(sp);
                        });
                        sheet.appendChild(rBar);
                        
                        const createBtn = (text, cls, action) => {
                            const btn = document.createElement('button'); btn.className = `sheet-btn ${cls||''}`;
                            btn.textContent = text; btn.onclick = action; sheet.appendChild(btn);
                        };
                        
                        createBtn("Reply", "", () => initReply(m));
                        if(m.type === 'text') {
                             createBtn("Copy Text", "", () => {
                                 navigator.clipboard.writeText(m.text).then(() => showToast("Copied"));
                                 hideActionSheet();
                             });
                        }
                        
                        if(isMe) createBtn("Unsend (Everyone)", "danger", () => deleteMsg(rid, m.id, 'everyone'));
                        createBtn("Delete for Me", "danger", () => deleteMsg(rid, m.id, 'me'));
                        
                        createBtn("Cancel", "", hideActionSheet);
                        get('actionSheetOverlay').classList.add('active');
                    });
                }
                list.appendChild(row);
            });
            
            if (isLoadMore) list.scrollTop = list.scrollHeight - prevScrollHeight;
            else if (wasAtBottom || !isLoadMore) scrollToBottom(); 
        });
        
        list.onscroll = () => {
           if(list.scrollTop === 0 && list.children.length >= msgLimit) {
               msgLimit += 20; loadMessages(rid, true);
           }
        };
    }

    async function deleteMsg(rid, mid, scope) {
        if(scope === 'everyone') {
             await updateDoc(doc(db, CHATS_PATH, rid, 'messages', mid), { type: 'deleted', text: 'deleted' });
             await updateDoc(doc(db, CHATS_PATH, rid), { 'lastMessage.type': 'deleted', 'lastMessage.text': 'deleted' });
        } else {
             await updateDoc(doc(db, CHATS_PATH, rid, 'messages', mid), { deletedFor: arrayUnion(currentUser.uid) });
        }
        hideActionSheet(); showToast("Message Deleted");
    }

    // --- MESSAGING & INPUTS ---
    function initReply(m) {
        let txt = m.text;
        if(m.type !== 'text') txt = `[${m.type}]`;
        replyTo = { id: m.id, text: txt, name: m.senderId===currentUser.uid?'You':currentPartnerData.displayName };
        get('replyToName').textContent = replyTo.name;
        get('replyTextPreview').textContent = replyTo.text;
        get('replyPreview').classList.add('active');
        get('msg-input').focus();
        hideActionSheet();
    }
    get('cancelReply').onclick = () => { replyTo = null; get('replyPreview').classList.remove('active'); };

    async function sendMsg(txt, type='text', fileName=null) {
        if(!txt) return;
        const payload = {
            senderId: currentUser.uid, text: txt, type: type, timestamp: serverTimestamp(), status: 'sent', reactions: {}, deletedFor: [], fileName: fileName
        };
        if(replyTo) { payload.replyTo = replyTo; get('cancelReply').click(); }
        
        await addDoc(collection(db, CHATS_PATH, currentChatId, 'messages'), payload);
        await updateDoc(doc(db, CHATS_PATH, currentChatId), {
            lastMessage: payload, updatedAt: serverTimestamp()
        });

        // --- TRIGGER PUSH NOTIFICATION ---
        sendPushNotification(currentPartnerId, currentUserData.displayName, type === 'text' ? txt : `Sent a ${type}`);

        playSound('snd-sent');
        isTyping = false; updateTypingStatus(false);
    }
    
    async function updateTypingStatus(status) {
        if(currentChatId) updateDoc(doc(db, CHATS_PATH, currentChatId), { [`typing.${currentUser.uid}`]: status }).catch(()=>{});
    }
    
    get('msg-input').addEventListener('input', () => {
        const hasText = get('msg-input').value.trim().length > 0;
        get('mic-btn').style.display = hasText ? 'none' : 'flex';
        get('send-btn').style.display = hasText ? 'flex' : 'none';
        if(!isTyping) { isTyping = true; updateTypingStatus(true); }
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => { isTyping = false; updateTypingStatus(false); }, 2000); 
    });
    get('msg-input').addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); get('send-btn').click(); } else playSound('snd-typing-click'); });
    get('send-btn').onclick = () => { const t = get('msg-input').value.trim(); if(t){ playSound('snd-btn-click'); sendMsg(t); get('msg-input').value=''; get('mic-btn').style.display='flex'; get('send-btn').style.display='none'; } };

    get('img-btn').onclick = () => openActionSheet([
        { text: "Photo", action: () => { get('img-input').click(); hideActionSheet(); } },
        { text: "Video", action: () => { get('video-input').click(); hideActionSheet(); } },
        { text: "Document", action: () => { get('file-input').click(); hideActionSheet(); } },
        { text: "Cancel", action: hideActionSheet }
    ]);

    const handleFileSelect = (file, type) => {
        if(!file) return;
        
        if(type === 'video') {
             if(file.size > 0.7 * 1024 * 1024) { 
                 return alert("Video too large for free server (Max 700KB). Please record a shorter clip.");
             }
        }
        
        if(type === 'file' && file.size > 1024 * 1024) return alert("File too large (Max 1MB)");

        showToast("Processing...");
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (ev) => {
            if(type === 'image') {
                const img = new Image(); img.src = ev.target.result;
                img.onload = () => {
                    const cvs = document.createElement('canvas'); 
                    const ctx = cvs.getContext('2d');
                    const MAX_SIZE = 1024;
                    let w = img.width; let h = img.height;
                    
                    if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; } }
                    else { if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; } }

                    cvs.width = w; cvs.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    const optimizedData = cvs.toDataURL('image/jpeg', 0.6);
                    sendMsg(optimizedData, 'image');
                };
            } else {
                sendMsg(ev.target.result, type, file.name);
            }
        };
    };
    get('img-input').onchange = (e) => handleFileSelect(e.target.files[0], 'image');
    get('video-input').onchange = (e) => handleFileSelect(e.target.files[0], 'video');
    get('file-input').onchange = (e) => handleFileSelect(e.target.files[0], 'file');

    const micBtn = get('mic-btn');
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const options = { mimeType: 'audio/webm;codecs=opus', bitsPerSecond: 16000 };
            try { mediaRecorder = new MediaRecorder(stream, options); } 
            catch(e) { mediaRecorder = new MediaRecorder(stream); }
            
            audioChunks = [];
            mediaRecorder.ondataavailable = (e) => { if(e.data.size > 0) audioChunks.push(e.data); };
            mediaRecorder.start(); isRecording = true;
            micBtn.classList.add('mic-active'); get('recording-overlay').classList.add('active');
            recordStartTime = Date.now();
            recordInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - recordStartTime)/1000);
                get('recording-timer').textContent = `0:${diff.toString().padStart(2,'0')}`;
                if(diff>=60) stopRecordingAndSend();
            }, 1000);
            playSound('snd-typing-click');
        } catch(e) { alert("Mic permission needed"); }
    }
    function stopRecordingAndSend() {
        if (!mediaRecorder || !isRecording) return;
        mediaRecorder.stop(); isRecording = false; clearInterval(recordInterval);
        micBtn.classList.remove('mic-active'); get('recording-overlay').classList.remove('active');
        mediaRecorder.onstop = () => {
            if (Date.now() - recordStartTime < 1000) return showToast("Hold longer");
            const reader = new FileReader(); reader.readAsDataURL(new Blob(audioChunks, { type: 'audio/webm' }));
            reader.onloadend = () => sendMsg(reader.result, 'audio');
        };
        mediaRecorder.stream.getTracks().forEach(t => t.stop());
    }
    micBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); startRecording(); });
    micBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); stopRecordingAndSend(); });
    micBtn.addEventListener('mousedown', (e)=>{ e.preventDefault(); startRecording(); });
    micBtn.addEventListener('mouseup', (e)=>{ e.preventDefault(); stopRecordingAndSend(); });

    // --- GLOBAL LISTENERS ---
    function listenGlobalMessages() {
        if(globalNotificationUnsubscribe) globalNotificationUnsubscribe();
        const q = query(collection(db, CHATS_PATH), where("participants", "array-contains", currentUser.uid));
        
        globalNotificationUnsubscribe = onSnapshot(q, (snap) => {
            snap.docChanges().forEach(change => {
                const d = change.doc.data();
                if(change.type === 'modified') {
                    if(d.callStatus) {
                        if(d.callStatus.state === 'calling' && d.callStatus.callerId !== currentUser.uid) {
                            if(Date.now() - d.callStatus.timestamp < 30000) {
                                playSound('snd-ringtone', true);
                                const callerInfo = d.participantInfo?.[d.callStatus.callerId] || { displayName: 'Unknown' };
                                get('incoming-call-name').textContent = callerInfo.displayName;
                                get('incoming-call-type').textContent = `Incoming ${d.callStatus.type} Call...`;
                                get('incoming-call-avatar').src = callerInfo.photoURL || 'https://i.postimg.cc/RZ5FH16z/Gemini-Generated-Image-rgsqsqrgsqsqrgsq-removebg-preview.png';
                                get('incoming-call-modal').style.display = 'flex';
                                get('incoming-call-modal').setAttribute('data-chat-id', change.doc.id);
                                get('btn-accept-incoming').onclick = () => acceptIncomingCall({ chatId: change.doc.id, type: d.callStatus.type });
                                
                                if(document.visibilityState === 'hidden') {
                                    sendSystemNotification("Incoming Call", `Call from ${callerInfo.displayName}`);
                                }
                            }
                        }
                        if(d.callStatus.state === 'ended' || d.callStatus.state === 'rejected') {
                             stopSound('snd-ringtone');
                             get('incoming-call-modal').style.display = 'none';
                        }
                    }

                    if(d.lastMessage && d.lastMessage.senderId !== currentUser.uid) {
                        const msgTime = d.lastMessage.timestamp ? (d.lastMessage.timestamp.seconds * 1000) : Date.now();
                        if (Date.now() - msgTime < 2000 && document.visibilityState === 'hidden') {
                             const senderName = d.participantInfo?.[d.lastMessage.senderId]?.displayName || 'PingMe User';
                             sendSystemNotification(senderName, d.lastMessage.text);
                        }
                    }
                }
            });
        });
    }
    
    // --- SEARCH PAGE LOGIC ---
    get('search-btn').onclick = async () => {
        const pid = get('search-ping-id').value.trim();
        const res = get('search-results'); res.innerHTML = 'Searching...';
        const q = query(collection(db, USERS_PATH), where("pingId", "==", pid));
        const snap = await getDocs(q);
        res.innerHTML = '';
        if(snap.empty) return (res.innerHTML = '<div style="text-align:center;">User not found</div>');
        snap.forEach(d => {
            const u = d.data();
            if(u.uid === currentUser.uid) return;
            const div = document.createElement('div');
            div.className = 'user-card search-result-card';
            div.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                    <img src="${u.photoURL || 'https://i.postimg.cc/RZ5FH16z/Gemini-Generated-Image-rgsqsqrgsqsqrgsq-removebg-preview.png'}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">
                    <div>${u.displayName}</div>
                </div>
                <button class="btn-msg-action">Chat</button>`;
            div.onclick = () => { addToHistory(u); openChat(u.uid, u); };
            res.appendChild(div);
        });
    };
    
    function addToHistory(u) {
        const k = `history_${currentUser.uid}`;
        let h = JSON.parse(localStorage.getItem(k)||'[]');
        h = h.filter(x => x.uid !== u.uid); 
        h.unshift({ uid: u.uid, displayName: u.displayName, photoURL: u.photoURL }); 
        localStorage.setItem(k, JSON.stringify(h.slice(0,5)));
    }
    
    window.loadSearchHistory = () => {
        const k = `history_${currentUser.uid}`;
        const h = JSON.parse(localStorage.getItem(k)||'[]');
        const list = get('history-list'); list.innerHTML = '';
        h.forEach(u => {
            const el = document.createElement('div');
            const imgHTML = u.photoURL 
                ? `<img src="${u.photoURL}" style="width:50px;height:50px;border-radius:50%;object-fit:cover;margin-bottom:4px;border:1px solid var(--border);">`
                : `<div class="avatar" style="width:50px;height:50px;margin-bottom:4px;">${u.displayName[0]}</div>`;
                
            el.innerHTML = `${imgHTML}<div style="font-size:10px;text-align:center;">${u.displayName.split(' ')[0]}</div>`;
            el.onclick = () => openChat(u.uid, u);
            list.appendChild(el);
        });
        get('search-history-section').style.display = h.length ? 'block' : 'none';
    };
    get('clear-history-btn').onclick = () => { localStorage.removeItem(`history_${currentUser.uid}`); loadSearchHistory(); };

    // --- HELPER UI ---
    window.viewImg = (src) => { get('lightbox-img').src=src; get('lightbox').classList.add('active'); };
    get('lightbox-close').onclick = () => get('lightbox').classList.remove('active');
    
    function openActionSheet(buttons) {
        const sheet = get('actionSheetContent'); 
        if(buttons) {
            sheet.innerHTML = '<div class="sheet-header">Select Option</div>';
            buttons.forEach(b => {
                const btn = document.createElement('button'); btn.className = `sheet-btn ${b.class||''}`;
                btn.textContent = b.text; btn.onclick = b.action; sheet.appendChild(btn);
            });
        }
        get('actionSheetOverlay').classList.add('active');
    }
    window.hideActionSheet = () => get('actionSheetOverlay').classList.remove('active');
    get('actionSheetOverlay').onclick = (e) => { if(e.target===get('actionSheetOverlay')) hideActionSheet(); };
    
    get('logout-btn').onclick = () => signOut(auth).then(()=>location.reload());
    
    get('auth-btn').onclick = () => {
        const btn = get('auth-btn');
        const originalText = btn.textContent;
        btn.innerHTML = '<div class="spring-spinner"></div>';
        btn.disabled = true;

        const e = get('auth-email').value, p = get('auth-pass').value;
        if(isLoginMode) {
            signInWithEmailAndPassword(auth, e, p)
                .then((c) => {window.OneSignalDeferred.push(function(OneSignal) {
            OneSignal.login(c.user.uid);
        });
                    alert(err.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        } else {
            createUserWithEmailAndPassword(auth, e, p).then(c => {window.OneSignalDeferred.push(function(OneSignal) {
        OneSignal.login(c.user.uid);
    });
                const name = get('auth-name').value;
                setDoc(doc(db, USERS_PATH, c.user.uid), { 
                    uid: c.user.uid, displayName: name, email: e, 
                    pingId: name.substr(0,4)+Math.floor(Math.random()*9000), status:'online'
                }).then(()=>location.reload());
            }).catch((err) => {
                alert(err.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
    };
    get('auth-toggle').onclick = () => { isLoginMode=!isLoginMode; get('signup-fields').classList.toggle('hidden'); get('auth-btn').textContent=isLoginMode?'Sign In':'Sign Up'; };
    
    const updatePresence = (s) => { if(currentUser) updateDoc(doc(db, USERS_PATH, currentUser.uid), { status: s, lastActive: serverTimestamp() }).catch(()=>{}); };
    document.addEventListener('visibilitychange', () => updatePresence(document.visibilityState==='visible'?'online':'offline'));
    setInterval(() => { if(currentUser && document.visibilityState==='visible') updatePresence('online'); }, 60000);

  </script>
</body>
</html>